{{define "content"}}
<div class="dashboard-container">
    <header class="dashboard-header">
        <div class="logo">
            <h1>BAMA</h1>
            <p>Book your ticket as soon as possible.</p>
        </div>
        <nav class="main-nav">
            <ul>
                <li class="active"><a href="/dashboard">Home</a></li>
                <li><a href="/trip-plan">Trip plan</a></li>
            </ul>
        </nav>
    </header>

    <div class="dashboard-content">
        <div class="sidebar">
            <div class="user-info">
                <h3>Welcome, {{.Username}}</h3>
                <p>Manager Dashboard</p>
            </div>
            <ul class="sidebar-menu">
                <li class="active"><a href="#overview">System Overview</a></li>
                <li><a href="#bookings">Manage Bookings</a></li>
                <li><a href="#members">Manage Members</a></li>
                <li><a href="#vehicles">Manage Vehicles</a></li>
                <li><a href="#trips">Manage Trips</a></li>
                <li><a href="#reports">Reports</a></li>
                <li><a href="#backup">System Backup</a></li>
                <li><a href="#settings">Account Settings</a></li>
            </ul>
        </div>

        <div class="main-content">
            {{if .Success}}
            <div class="alert alert-success">{{.Success}}</div>
            {{end}}
            
            {{if .Error}}
            <div class="alert alert-error">{{.Error}}</div>
            {{end}}

            <div class="content-section active" id="overview-section">
                <div class="card" style="background: linear-gradient(135deg, #f7fafc 60%, #e3f0ff 100%); box-shadow: 0 4px 24px rgba(52,152,219,0.08);">
                    <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem;">
                        <img src="/static/images/backup/rocket.svg" alt="Welcome" style="width: 64px; height: 64px;">
                        <div>
                            <h2 style="margin: 0; font-size: 2rem; color: #2980b9;">Welcome, {{.Username}}!</h2>
                            <p style="margin: 0.5rem 0 0 0; color: #555; font-size: 1.1rem;">This is your admin control center. Quickly access any management area below.</p>
                        </div>
                    </div>
                    <div class="overview-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                        <a href="#bookings" class="overview-feature">
                            <div class="feature-icon">üé´</div>
                            <div class="feature-title">Bookings</div>
                            <div class="feature-desc">View and manage all ticket bookings.</div>
                        </a>
                        <a href="#members" class="overview-feature">
                            <div class="feature-icon">üë§</div>
                            <div class="feature-title">Members</div>
                            <div class="feature-desc">Manage user accounts and permissions.</div>
                        </a>
                        <a href="#vehicles" class="overview-feature">
                            <div class="feature-icon">üöç</div>
                            <div class="feature-title">Vehicles</div>
                            <div class="feature-desc">Add, edit, or remove vehicles.</div>
                        </a>
                        <a href="#trips" class="overview-feature">
                            <div class="feature-icon">üó∫Ô∏è</div>
                            <div class="feature-title">Trips</div>
                            <div class="feature-desc">Plan and manage all trips.</div>
                        </a>
                        <a href="#reports" class="overview-feature">
                            <div class="feature-icon">üìä</div>
                            <div class="feature-title">Reports</div>
                            <div class="feature-desc">Generate and export system reports.</div>
                        </a>
                        <a href="#backup" class="overview-feature">
                            <div class="feature-icon">üíæ</div>
                            <div class="feature-title">Backup</div>
                            <div class="feature-desc">Backup and restore your data.</div>
                        </a>
                        <a href="#settings" class="overview-feature">
                            <div class="feature-icon">‚öôÔ∏è</div>
                            <div class="feature-title">Account Settings</div>
                            <div class="feature-desc">Manage your account details, security question, and password.</div>
                        </a>
                    </div>
                </div>
                <style>
                .overview-feature {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                    background: #fff;
                    border-radius: 10px;
                    box-shadow: 0 2px 8px rgba(52,152,219,0.07);
                    padding: 1.25rem 1.5rem;
                    text-decoration: none;
                    color: #222;
                    transition: box-shadow 0.2s, transform 0.2s;
                    border: 1px solid #f0f4fa;
                }
                .overview-feature:hover {
                    box-shadow: 0 6px 24px rgba(52,152,219,0.13);
                    transform: translateY(-2px) scale(1.03);
                    border-color: #b2d6f8;
                }
                .feature-icon {
                    font-size: 2.2rem;
                    margin-bottom: 0.5rem;
                }
                .feature-title {
                    font-weight: 600;
                    font-size: 1.15rem;
                    margin-bottom: 0.25rem;
                    color: #2980b9;
                }
                .feature-desc {
                    font-size: 0.97rem;
                    color: #555;
                }
                </style>
            </div>

            <div class="content-section" id="bookings-section">
                <div class="card">
                    <h2>Manage Bookings</h2>
                    <p>Manage all ticket bookings in the system.</p>
                    
                    <div class="action-bar">
                        <button class="btn-primary" id="add-booking-btn">Add New Booking</button>
                        <div class="search-box">
                            <input type="text" id="booking-search" placeholder="Search bookings...">
                            <button class="btn-icon">üîç</button>
                        </div>
                    </div>
                    
                    <div class="bookings-section">
                        <h2>Bookings Management</h2>
                        
                        <div class="filter-section">
                            <div class="filter-row">
                                <div class="form-group">
                                    <label for="filter-passenger">Passenger Name</label>
                                    <input type="text" id="filter-passenger" placeholder="Filter by passenger">
                                </div>
                                <div class="form-group">
                                    <label for="filter-origin">Origin</label>
                                    <select id="filter-origin">
                                        <option value="">All Origins</option>
                                        <!-- Will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="filter-destination">Destination</label>
                                    <select id="filter-destination">
                                        <option value="">All Destinations</option>
                                        <!-- Will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="filter-status">Status</label>
                                    <select id="filter-status">
                                        <option value="">All Statuses</option>
                                        <option value="Confirmed">Confirmed</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="form-group">
                                    <label for="filter-date-from">Date From</label>
                                    <input type="date" id="filter-date-from">
                                </div>
                                <div class="form-group">
                                    <label for="filter-date-to">Date To</label>
                                    <input type="date" id="filter-date-to">
                                </div>
                            </div>
                            <div class="filter-actions">
                                <button id="filter-apply" class="btn-primary">Apply Filters</button>
                                <button id="filter-reset" class="btn-secondary">Reset</button>
                            </div>
                        </div>
                        
                        <div class="sort-section">
                            <label for="sort-by">Sort by:</label>
                            <select id="sort-by">
                                <option value="date">Booking Date</option>
                                <option value="passenger">Passenger Name</option>
                                <option value="status">Status</option>
                                <option value="origin">Origin</option>
                                <option value="destination">Destination</option>
                            </select>
                            <select id="sort-direction">
                                <option value="desc">Descending</option>
                                <option value="asc">Ascending</option>
                            </select>
                            <button id="sort-apply" class="btn-primary">Apply Sort</button>
                        </div>
                        
                            <!-- <button id="add-booking-btn" class="btn-primary">Add Booking</button> -->
                        </div>
                        
                        <div class="pagination-controls" style="display:flex;align-items:center;gap:1rem;margin:1rem 0;">
                            <label for="page-size-select">Page size:</label>
                            <select id="page-size-select">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <button id="prev-page" class="btn-secondary">Previous</button>
                            <span>Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
                            <button id="next-page" class="btn-secondary">Next</button>
                        </div>
                        <div class="bookings-table">
                            <!-- Table will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Add Booking Modal -->
                    <div id="add-booking-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3>Add New Booking</h3>
                            <form id="add-booking-form">
                                <div class="form-group">
                                    <label for="booking-trip">Trip</label>
                                    <select id="booking-trip" name="trip_id" required></select>
                                    <div id="trip-capacity-info" class="capacity-info"></div>
                                </div>
                                <div class="form-group">
                                    <label for="booking-passenger">Passenger Name</label>
                                    <input type="text" id="booking-passenger" name="passenger" required pattern="^[A-Za-z\s]{2,50}$" title="Name must be 2‚Äì50 letters" maxlength="50">
                                </div>
                                <div class="form-group">
                                    <label for="booking-social-id">Social ID</label>
                                    <input type="text" id="booking-social-id" name="social_id" required pattern="^[0-9]{10}$" title="Social ID must be exactly 10 digits" maxlength="10" inputmode="numeric">
                                </div>
                                <div class="form-group">
                                    <label for="booking-phone">Phone Number</label>
                                    <input type="tel" id="booking-phone" name="phone_number" required pattern="^\+?[0-9]{7,15}$" title="Phone number must be 7‚Äì15 digits; may start with +" maxlength="15">
                                </div>
                                <div class="form-group">
                                    <label for="booking-dob">Date of Birth</label>
                                    <input type="date" id="booking-dob" name="date_of_birth" required>
                                </div>
                                <div class="form-group">
                                    <label for="booking-status">Status</label>
                                    <select id="booking-status" name="status">
                                        <option value="Confirmed">Confirmed</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                                    <button type="submit" class="btn-primary">Add Booking</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Edit Booking Modal -->
                    <div id="edit-booking-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3>Edit Booking</h3>
                            <form id="edit-booking-form">
                                <input type="hidden" id="edit-booking-id">
                                <div class="form-group">
                                    <label for="edit-booking-trip">Trip</label>
                                    <select id="edit-booking-trip" name="trip_id" required></select>
                                    <div id="edit-trip-capacity-info" class="capacity-info"></div>
                                </div>
                                <div class="form-group">
                                    <label for="edit-booking-passenger">Passenger Name</label>
                                    <input type="text" id="edit-booking-passenger" name="passenger" required pattern="^[A-Za-z\s]{2,50}$" title="Name must be 2‚Äì50 letters" maxlength="50">
                                </div>
                                <div class="form-group">
                                    <label for="edit-booking-social-id">Social ID</label>
                                    <input type="text" id="edit-booking-social-id" name="social_id" required pattern="^[0-9]{10}$" title="Social ID must be exactly 10 digits" maxlength="10" inputmode="numeric">
                                </div>
                                <div class="form-group">
                                    <label for="edit-booking-phone">Phone Number</label>
                                    <input type="tel" id="edit-booking-phone" name="phone_number" required pattern="^\+?[0-9]{7,15}$" title="Phone number must be 7‚Äì15 digits; may start with +" maxlength="15">
                                </div>
                                <div class="form-group">
                                    <label for="edit-booking-dob">Date of Birth</label>
                                    <input type="date" id="edit-booking-dob" name="date_of_birth" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-booking-status">Status</label>
                                    <select id="edit-booking-status" name="status">
                                        <option value="Confirmed">Confirmed</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                                    <button type="submit" class="btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-section" id="members-section">
                <div class="card">
                    <h2>Manage Members</h2>
                    <p>Manage all customer accounts and memberships.</p>
                    
                    <div class="action-bar">
                        <button class="btn-primary" id="add-member-btn">Add New Member</button>
                        <div class="search-box">
                            <input type="text" id="member-search" placeholder="Search members...">
                            <button class="btn-icon">üîç</button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="members-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Created At</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    
                    <!-- Add Member Modal -->
                    <div id="add-member-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3>Add New Member</h3>
                            <form id="add-member-form">
                                <div class="form-group">
                                    <label for="member-name">Username</label>
                                    <input type="text" id="member-name" name="name" required maxlength="30">
                                    <div id="addUsernameError" class="form-error-message" style="display: none; color: red; font-size: 0.8em; margin-top: 4px;"></div>
                                </div>
                                <div class="form-group">
                                    <label for="member-email">Email</label>
                                    <input type="email" id="member-email" name="email" required maxlength="254">
                                </div>
                                <div class="form-group">
                                    <label for="member-role">Role</label>
                                    <select id="member-role" name="role">
                                        <option value="Operator">Operator</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Accountant">Accountant</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="member-password">Initial Password</label>
                                    <div class="password-wrapper">
                                        <input type="password" id="member-password" name="password" required maxlength="30">
                                        <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                        </button>
                                    </div>
                                    <ul class="passwordCriteria" style="display: none; list-style: none; padding-left: 0; margin-top: 4px;">
                                        <li class="passwordLength" style="color: red;">‚òÖ At least 8 characters</li>
                                        <li class="passwordUpper" style="color: red;">‚òÖ At least one uppercase letter</li>
                                        <li class="passwordLower" style="color: red;">‚òÖ At least one lowercase letter</li>
                                        <li class="passwordNumber" style="color: red;">‚òÖ At least one number</li>
                                        <li class="passwordSymbol" style="color: red;">‚òÖ At least one special character</li>
                                    </ul>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                                    <button type="submit" class="btn-primary">Add Member</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Edit Member Modal -->
                    <div id="edit-member-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3>Edit Member</h3>
                            <form id="edit-member-form">
                                <input type="hidden" id="edit-member-id">
                                <div class="form-group">
                                    <label for="edit-member-name">Full Name</label>
                                    <input type="text" id="edit-member-name" name="name" required maxlength="30">
                                    <div id="editUsernameError" class="form-error-message" style="display: none; color: red; font-size: 0.8em; margin-top: 4px;"></div>
                                </div>
                                <div class="form-group">
                                    <label for="edit-member-email">Email</label>
                                    <input type="email" id="edit-member-email" name="email" required maxlength="254">
                                </div>
                                <div class="form-group">
                                    <label for="edit-member-role">Role</label>
                                    <select id="edit-member-role" name="role">
                                        <option value="Operator">Operator</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Accountant">Accountant</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-member-password">New Password (leave blank to keep current)</label>
                                    <div class="password-wrapper">
                                        <input type="password" id="edit-member-password" name="password">
                                        <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                        </button>
                                    </div>
                                    <ul class="passwordCriteria" style="display: none; list-style: none; padding-left: 0; margin-top: 4px;">
                                        <li class="passwordLength" style="color: red;">‚òÖ At least 8 characters</li>
                                        <li class="passwordUpper" style="color: red;">‚òÖ At least one uppercase letter</li>
                                        <li class="passwordLower" style="color: red;">‚òÖ At least one lowercase letter</li>
                                        <li class="passwordNumber" style="color: red;">‚òÖ At least one number</li>
                                        <li class="passwordSymbol" style="color: red;">‚òÖ At least one special character</li>
                                    </ul>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                                    <button type="submit" class="btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Change Role Modal -->
                    <div id="change-role-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3>Change Staff Role</h3>
                            <form id="change-role-form">
                                <input type="hidden" id="change-role-user-id">
                                <div class="form-group">
                                    <label for="change-role-username">Username</label>
                                    <input type="text" id="change-role-username" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="change-role-select">Role</label>
                                    <select id="change-role-select" name="role">
                                        <option value="Operator">Operator</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Accountant">Accountant</option>
                                    </select>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                                    <button type="submit" class="btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Change Password Modal -->
                    <div id="change-password-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3>Change Staff Password</h3>
                            <form id="change-password-form">
                                <input type="hidden" id="change-password-user-id">
                                <div class="form-group">
                                    <label for="change-password-username">Username</label>
                                    <input type="text" id="change-password-username" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="new-password">New Password</label>
                                    <div class="password-wrapper">
                                        <input type="password" id="new-password" name="password" required maxlength="30">
                                        <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                        </button>
                                    </div>
                                    <ul class="passwordCriteria" style="display: none; list-style: none; padding-left: 0; margin-top: 4px;">
                                        <li class="passwordLength" style="color: red;">‚òÖ At least 8 characters</li>
                                        <li class="passwordUpper" style="color: red;">‚òÖ At least one uppercase letter</li>
                                        <li class="passwordLower" style="color: red;">‚òÖ At least one lowercase letter</li>
                                        <li class="passwordNumber" style="color: red;">‚òÖ At least one number</li>
                                        <li class="passwordSymbol" style="color: red;">‚òÖ At least one special character</li>
                                    </ul>
                                </div>
                                <div class="form-group">
                                    <label for="confirm-password">Confirm Password</label>
                                    <div class="password-wrapper">
                                        <input type="password" id="confirm-password" name="confirm-password" required maxlength="30">
                                        <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                                    <button type="submit" class="btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Change Username Modal -->
                    <div id="change-username-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3>Change Staff Username</h3>
                            <form id="change-username-form">
                                <input type="hidden" id="change-username-user-id">
                                <div class="form-group">
                                    <label for="current-username">Current Username</label>
                                    <input type="text" id="current-username" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="new-username">New Username</label>
                                    <input type="text" id="new-username" name="username" required maxlength="30">
                                    <div id="changeUsernameError" class="form-error-message" style="display: none; color: red; font-size: 0.8em; margin-top: 4px;"></div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                                    <button type="submit" class="btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-section" id="vehicles-section">
                <div class="card">
                    <h2>Manage Vehicles</h2>
                    <p>Manage all transportation vehicles in the system.</p>
                    
                    <div class="action-bar">
                        <button class="btn-primary" id="add-vehicle-btn">Add New Vehicle</button>
                        <div class="search-box">
                            <input type="text" id="vehicle-search" placeholder="Search vehicles...">
                            <button class="btn-icon">üîç</button>
                        </div>
                    </div>
                    
                    <!-- Vehicle filter panel -->
                    <div class="filter-section">
                        <div class="filter-row">
                            <div class="form-group">
                                <label for="filter-vehicle-number">Vehicle Number</label>
                                <input type="text" id="filter-vehicle-number" placeholder="Filter by number">
                            </div>
                            <div class="form-group">
                                <label for="filter-vehicle-type">Type</label>
                                <select id="filter-vehicle-type">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filter-vehicle-status">Status</label>
                                <select id="filter-vehicle-status">
                                    <option value="">All Statuses</option>
                                    <option value="Ready">Ready</option>
                                    <option value="On a trip">On a trip</option>
                                    <option value="Under repair">Under repair</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-row">
                            <div class="form-group">
                                <label for="filter-vehicle-capacity-min">Min Capacity</label>
                                <input type="number" id="filter-vehicle-capacity-min" min="1" placeholder="Min capacity">
                            </div>
                            <div class="form-group">
                                <label for="filter-vehicle-capacity-max">Max Capacity</label>
                                <input type="number" id="filter-vehicle-capacity-max" min="1" placeholder="Max capacity">
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button id="vehicle-filter-apply" class="btn-primary">Apply Filters</button>
                            <button id="vehicle-filter-reset" class="btn-secondary">Reset</button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="vehicles-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Vehicle Number</th>
                                    <th>Type</th>
                                    <th>Capacity</th>
                                    <th>Status</th>
                                    <th>Last Maintenance</th>
                                    <th>Next Maintenance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    
                    <!-- Add Vehicle Modal -->
                    <div id="add-vehicle-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3>Add New Vehicle</h3>
                            <form id="add-vehicle-form">
                                <div class="form-group">
                                    <label for="vehicle-number">Vehicle Number</label>
                                    <input type="text" id="vehicle-number" name="vehicle_number" required pattern="^[A-Za-z0-9\- ]{1,20}$" title="Vehicle number must be 1‚Äì20 alphanumeric characters or hyphens" maxlength="20">
                                </div>
                                <div class="form-group">
                                    <label for="vehicle-type">Vehicle Type</label>
                                    <select id="vehicle-type" name="type">
                                        <option value="Bus">Bus</option>
                                        <option value="Mini Bus">Mini Bus</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="vehicle-capacity">Capacity</label>
                                    <input type="number" id="vehicle-capacity" name="capacity" required min="1" max="500" title="Capacity must be between 1 and 500">
                                </div>
                                <div class="form-group">
                                    <label for="vehicle-status">Status</label>
                                    <select id="vehicle-status" name="status">
                                        <option value="Ready">Ready</option>
                                        <option value="On a trip">On a trip</option>
                                        <option value="Under repair">Under repair</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="vehicle-last-maintenance">Last Maintenance Date</label>
                                    <input type="date" id="vehicle-last-maintenance" name="last_maintenance">
                                </div>
                                <div class="form-group">
                                    <label for="vehicle-next-maintenance">Next Maintenance Date</label>
                                    <input type="date" id="vehicle-next-maintenance" name="next_maintenance">
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                                    <button type="submit" class="btn-primary">Add Vehicle</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Edit Vehicle Modal -->
                    <div id="edit-vehicle-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3>Edit Vehicle</h3>
                            <form id="edit-vehicle-form">
                                <input type="hidden" id="edit-vehicle-id">
                                <div class="form-group">
                                    <label for="edit-vehicle-number">Vehicle Number</label>
                                    <input type="text" id="edit-vehicle-number" name="vehicle_number" required pattern="^[A-Za-z0-9\- ]{1,20}$" title="Vehicle number must be 1‚Äì20 alphanumeric characters or hyphens" maxlength="20">
                                </div>
                                <div class="form-group">
                                    <label for="edit-vehicle-type">Vehicle Type</label>
                                    <select id="edit-vehicle-type" name="type">
                                        <option value="Bus">Bus</option>
                                        <option value="Mini Bus">Mini Bus</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-vehicle-capacity">Capacity</label>
                                    <input type="number" id="edit-vehicle-capacity" name="capacity" required min="1" max="500" title="Capacity must be between 1 and 500">
                                </div>
                                <div class="form-group">
                                    <label for="edit-vehicle-status">Status</label>
                                    <select id="edit-vehicle-status" name="status">
                                        <option value="Ready">Ready</option>
                                        <option value="On a trip">On a trip</option>
                                        <option value="Under repair">Under repair</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-vehicle-last-maintenance">Last Maintenance Date</label>
                                    <input type="date" id="edit-vehicle-last-maintenance" name="last_maintenance">
                                </div>
                                <div class="form-group">
                                    <label for="edit-vehicle-next-maintenance">Next Maintenance Date</label>
                                    <input type="date" id="edit-vehicle-next-maintenance" name="next_maintenance">
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                                    <button type="submit" class="btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Vehicle Details Modal -->
                    <div id="view-vehicle-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3>Vehicle Details</h3>
                            <div id="vehicle-details">
                                <div class="detail-group">
                                    <strong>Vehicle Number:</strong>
                                    <span id="detail-vehicle-number"></span>
                                </div>
                                <div class="detail-group">
                                    <strong>Type:</strong>
                                    <span id="detail-vehicle-type"></span>
                                </div>
                                <div class="detail-group">
                                    <strong>Capacity:</strong>
                                    <span id="detail-vehicle-capacity"></span>
                                </div>
                                <div class="detail-group">
                                    <strong>Status:</strong>
                                    <span id="detail-vehicle-status"></span>
                                </div>
                                <div class="detail-group">
                                    <strong>Last Maintenance:</strong>
                                    <span id="detail-vehicle-last-maintenance"></span>
                                </div>
                                <div class="detail-group">
                                    <strong>Next Maintenance:</strong>
                                    <span id="detail-vehicle-next-maintenance"></span>
                                </div>
                                <div class="detail-group">
                                    <strong>Created At:</strong>
                                    <span id="detail-vehicle-created"></span>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn-secondary cancel-btn">Close</button>
                                <button type="button" class="btn-primary" id="detail-edit-btn">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Manage Trips Section -->
            <div class="content-section" id="trips-section">
                <div class="card">
                    <h2>Manage Trips</h2>
                    <p>Manage all scheduled trips in the system.</p>
                    <div class="action-bar">
                        <button class="btn-primary" id="add-trip-btn">Add New Trip</button>
                        <div class="search-box">
                            <input type="text" id="trip-search" placeholder="Search trips...">
                            <button class="btn-icon">üîç</button>
                        </div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-row">
                            <div class="form-group">
                                <label for="filter-trip-origin">Origin</label>
                                <select id="filter-trip-origin">
                                    <option value="">All Origins</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filter-trip-destination">Destination</label>
                                <select id="filter-trip-destination">
                                    <option value="">All Destinations</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filter-trip-vehicle">Vehicle</label>
                                <select id="filter-trip-vehicle">
                                    <option value="">All Vehicles</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-row">
                            <div class="form-group">
                                <label for="filter-departure-from">Departure From</label>
                                <input type="datetime-local" id="filter-departure-from">
                            </div>
                            <div class="form-group">
                                <label for="filter-departure-to">Departure To</label>
                                <input type="datetime-local" id="filter-departure-to">
                            </div>
                            <div class="form-group">
                                <label for="filter-arrival-from">Arrival From</label>
                                <input type="datetime-local" id="filter-arrival-from">
                            </div>
                            <div class="form-group">
                                <label for="filter-arrival-to">Arrival To</label>
                                <input type="datetime-local" id="filter-arrival-to">
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button id="trip-filter-apply" class="btn-primary">Apply Filters</button>
                            <button id="trip-filter-reset" class="btn-secondary">Reset</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="trips-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Origin</th>
                                    <th>Destination</th>
                                    <th>Vehicle</th>
                                    <th>Departure</th>
                                    <th>Arrival</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Add Trip Modal -->
                    <div id="add-trip-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h3>Add New Trip</h3>
                            <form id="add-trip-form">
                                <div class="form-group">
                                    <label for="trip-origin">Origin</label>
                                    <select id="trip-origin" name="origin">
                                        <option value="Tehran" selected>Tehran</option>
                                        <option value="Mashhad">Mashhad</option>
                                        <option value="Isfahan">Isfahan</option>
                                        <option value="Karaj">Karaj</option>
                                        <option value="Shiraz">Shiraz</option>
                                        <option value="Tabriz">Tabriz</option>
                                        <option value="Qom">Qom</option>
                                        <option value="Ahvaz">Ahvaz</option>
                                        <option value="Kermanshah">Kermanshah</option>
                                        <option value="Urmia">Urmia</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="trip-destination">Destination</label>
                                    <select id="trip-destination" name="destination">
                                        <option value="Tehran">Tehran</option>
                                        <option value="Mashhad" selected>Mashhad</option>
                                        <option value="Isfahan">Isfahan</option>
                                        <option value="Karaj">Karaj</option>
                                        <option value="Shiraz">Shiraz</option>
                                        <option value="Tabriz">Tabriz</option>
                                        <option value="Qom">Qom</option>
                                        <option value="Ahvaz">Ahvaz</option>
                                        <option value="Kermanshah">Kermanshah</option>
                                        <option value="Urmia">Urmia</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="trip-vehicle">Vehicle</label>
                                    <select id="trip-vehicle" name="vehicle_id"></select>
                                </div>
                                <div class="form-group">
                                    <label for="trip-departure">Departure Time</label>
                                    <input type="datetime-local" id="trip-departure" name="departure_time" required>
                                </div>
                                <div class="form-group">
                                    <label for="trip-arrival">Arrival Time</label>
                                    <input type="datetime-local" id="trip-arrival" name="arrival_time" required>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                                    <button type="submit" class="btn-primary">Add Trip</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Edit Trip Modal -->
                    <div id="edit-trip-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2>Edit Trip</h2>
                            <form id="edit-trip-form">
                                <input type="hidden" id="edit-trip-id">
                                
                                <div id="edit-trip-booking-warning" style="display: none;"></div>
                                
                                <label for="edit-trip-origin">Origin</label>
                                <select id="edit-trip-origin" name="origin">
                                    <option value="Tehran">Tehran</option>
                                    <option value="Mashhad">Mashhad</option>
                                    <option value="Isfahan">Isfahan</option>
                                    <option value="Shiraz">Shiraz</option>
                                    <option value="Tabriz">Tabriz</option>
                                    <option value="Yazd">Yazd</option>
                                    <option value="Kerman">Kerman</option>
                                    <option value="Ahvaz">Ahvaz</option>
                                    <option value="Hamedan">Hamedan</option>
                                    <option value="Rasht">Rasht</option>
                                    <option value="Sari">Sari</option>
                                </select>
                                
                                <label for="edit-trip-destination">Destination</label>
                                <select id="edit-trip-destination" name="destination">
                                    <option value="Tehran">Tehran</option>
                                    <option value="Mashhad">Mashhad</option>
                                    <option value="Isfahan">Isfahan</option>
                                    <option value="Shiraz">Shiraz</option>
                                    <option value="Tabriz">Tabriz</option>
                                    <option value="Yazd">Yazd</option>
                                    <option value="Kerman">Kerman</option>
                                    <option value="Ahvaz">Ahvaz</option>
                                    <option value="Hamedan">Hamedan</option>
                                    <option value="Rasht">Rasht</option>
                                    <option value="Sari">Sari</option>
                                </select>
                                <div class="form-group">
                                    <label for="edit-trip-vehicle">Vehicle</label>
                                    <select id="edit-trip-vehicle" name="vehicle_id"></select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-trip-departure">Departure Time</label>
                                    <input type="datetime-local" id="edit-trip-departure" name="departure_time" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-trip-arrival">Arrival Time</label>
                                    <input type="datetime-local" id="edit-trip-arrival" name="arrival_time" required>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                                    <button type="submit" class="btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>  <!-- end of action-bar -->
            </div>
            
            <div class="content-section" id="reports-section">
                <div class="card">
                    <h2>Reports</h2>
                    <p>Generate and view all system reports.</p>
                    <!-- Report Controls -->
                    <div class="report-controls" style="margin-bottom: 1.5rem;">
                        <div class="filter-row" style="display:flex;gap:1rem;flex-wrap:wrap;">
                            <div class="form-group">
                                <label for="report-type-select">Report Type</label>
                                <select id="report-type-select">
                                    <option value="">Select Report</option>
                                    <option value="booking_summary">Booking Summary</option>
                                    <option value="route_performance">Route Performance</option>
                                    <option value="cancellation_summary">Cancellation Summary</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="report-from-date">From</label>
                                <input type="date" id="report-from-date">
                            </div>
                            <div class="form-group">
                                <label for="report-to-date">To</label>
                                <input type="date" id="report-to-date">
                            </div>
                            <div class="form-actions" style="display:flex;align-items:flex-end;gap:1rem;">
                                <button id="report-generate-btn" class="btn-primary">Generate</button>
                                <button id="report-export-btn" class="btn-secondary">Export to Excel</button>
                            </div>
                        </div>
                    </div>
                    <!-- Report Output -->
                    <div id="report-output"></div>
                </div>
            </div>
            
            <div class="content-section" id="backup-section">
                <div class="card">
                    <h2>System Backup</h2>
                    <p>Manage system backups and recovery options.</p>
                    <!-- Content similar to other sections -->
                    <div class="backup-controls" style="margin-bottom: 1.5rem;">
                        <button id="backup-now-btn" class="btn-primary">Backup Now</button>
                        <a id="backup-download-link" class="btn-secondary" href="#" hidden>Download Backup</a>
                    </div>
                    <div id="backup-status"></div>
                </div>
            </div>
            
            <div class="content-section" id="settings-section">
                <div class="card">
                    <h2>Account Settings</h2>
                    <p>Manage your account details, security question, and password.</p>
                    <div class="action-bar" style="display:flex; gap:1rem; margin-top:1rem;">
                        <a href="/setup-security" class="btn-primary">Manage Security Question</a>
                        <a href="/security-reset" class="btn-secondary">Reset Password</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .dashboard-container {
        width: 100%;
        min-height: 100vh;
        background-color: #f7f9fc;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .logo h1 {
        font-size: 2rem;
        margin: 0;
        color: #333;
    }

    .logo p {
        margin: 0;
        font-size: 0.85rem;
        color: #666;
    }

    .main-nav ul {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .main-nav li {
        margin: 0 1rem;
    }

    .main-nav a {
        text-decoration: none;
        color: #666;
        font-weight: 500;
        padding: 0.5rem;
        border-radius: 4px;
        transition: all 0.3s ease;
    }

    .main-nav li.active a,
    .main-nav a:hover {
        color: #3498db;
        background-color: rgba(52, 152, 219, 0.1);
    }

    .logout-btn a {
        color: #e74c3c;
    }

    .dashboard-content {
        display: flex;
        padding: 2rem;
    }

    .sidebar {
        width: 250px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-right: 2rem;
    }

    .user-info {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
    }

    .user-info h3 {
        margin: 0 0 0.5rem 0;
        color: #333;
    }

    .user-info p {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
    }

    .sidebar-menu {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .sidebar-menu li {
        margin-bottom: 0.5rem;
    }

    .sidebar-menu a {
        display: block;
        padding: 0.75rem 1rem;
        text-decoration: none;
        color: #666;
        border-radius: 4px;
        transition: all 0.3s ease;
    }

    .sidebar-menu li.active a,
    .sidebar-menu a:hover {
        color: #3498db;
        background-color: rgba(52, 152, 219, 0.1);
    }

    .main-content {
        flex: 1;
        /* allow horizontal overflow for internal scrollable areas */
    }

    .card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .card h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
    }

    .alert {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert-info {
        background-color: #e1f5fe;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .alert h3 {
        margin-top: 0;
        display: flex;
        align-items: center;
    }

    .alert .icon {
        margin-right: 10px;
    }

    .stats-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        flex: 1;
        min-width: 200px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: #666;
        font-size: 0.9rem;
    }

    .action-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }

    .search-box {
        display: flex;
        align-items: center;
    }

    .search-box input {
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px 0 0 4px;
        font-size: 1rem;
        width: 250px;
    }

    .btn-icon {
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-left: none;
        border-radius: 0 4px 4px 0;
        background-color: #f8f9fa;
        cursor: pointer;
    }

    .table-responsive {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    th {
        font-weight: 600;
        color: #333;
        background-color: #f9f9f9;
    }

    .status-active {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background-color: #d4edda;
        color: #155724;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .status-inactive {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background-color: #f8d7da;
        color: #721c24;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .status-pending {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background-color: #fff3cd;
        color: #856404;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .btn-primary,
    .btn-warning,
    .btn-success,
    .btn-small {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background-color: #3498db;
        color: #fff;
    }

    .btn-primary:hover {
        background-color: #2980b9;
    }

    .btn-warning {
        background-color: #e74c3c;
        color: #fff;
    }

    .btn-warning:hover {
        background-color: #c0392b;
    }

    .btn-success {
        background-color: #2ecc71;
        color: #fff;
    }

    .btn-success:hover {
        background-color: #27ae60;
    }

    .btn-small {
        padding: 0.3rem 0.75rem;
        font-size: 0.85rem;
        background-color: #3498db;
        color: #fff;
    }

    .btn-small.btn-warning {
        background-color: #e74c3c;
    }

    .btn-small.btn-success {
        background-color: #2ecc71;
    }

    .content-section {
        display: none;
    }

    .content-section.active {
        display: block;
    }
    
    /* Vehicle styles */
    .detail-group {
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
    }
    
    .detail-group strong {
        display: inline-block;
        width: 150px;
        color: #333;
    }
    
    .detail-group:last-child {
        border-bottom: none;
    }
    
    .detail-group p {
        margin-top: 0.5rem;
        white-space: pre-line;
    }
    
    /* Vehicle management layouts */
    #vehicles-section {
        position: relative;
        width: 100%;
        background: #FFFFFF;
    }
    
    #add-vehicle-modal .modal-content,
    #edit-vehicle-modal .modal-content,
    #view-vehicle-modal .modal-content {
        position: relative;
        background: #FFFFFF;
        width: 90%;
        max-width: 600px;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        width: 500px;
        max-width: 90%;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: #333;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .btn-secondary {
        background-color: #95a5a6;
        color: #fff;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
    }
    
    .btn-secondary:hover {
        background-color: #7f8c8d;
    }

    /* Status dropdown styling */
    #vehicle-status, #edit-vehicle-status {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 0.5rem;
        width: 100%;
    }
    
    /* Status dropdown options styling */
    #vehicle-status option[value="Ready"],
    #edit-vehicle-status option[value="Ready"] {
        background-color: #d4edda;
        color: #155724;
    }
    
    #vehicle-status option[value="On a trip"],
    #edit-vehicle-status option[value="On a trip"] {
        background-color: #fff3cd;
        color: #856404;
    }
    
    #vehicle-status option[value="Under repair"],
    #edit-vehicle-status option[value="Under repair"] {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    /* Error field styling */
    .error-field {
        border: 1px solid #e74c3c !important;
        background-color: #ffeaea !important;
    }

    /* Trip capacity styles */
    .capacity-info {
        margin-top: 0.5rem;
        font-size: 0.9rem;
    }
    
    .capacity-details {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        padding: 0.5rem;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .capacity-total {
        color: #495057;
    }
    
    .capacity-booked {
        color: #6c757d;
    }
    
    .capacity-available {
        font-weight: 500;
        color: #0366d6;
    }
    
    .capacity-status {
        font-weight: 700;
        padding: 0.15rem 0.5rem;
        border-radius: 3px;
    }
    
    .capacity-status.available {
        background-color: #d4edda;
        color: #155724;
    }
    
    .capacity-status.full {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .capacity-status.limited {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .capacity-unknown {
        color: #6c757d;
        font-style: italic;
    }
    
    .loading {
        font-style: italic;
        color: #6c757d;
    }
    
    .error {
        color: #dc3545;
    }
    
    /* Toast notification system */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
    }
    
    .toast {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-radius: 4px;
        margin-bottom: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        animation: toast-slide-in 0.3s ease-out forwards;
        max-width: 350px;
        opacity: 0;
    }
    
    .toast-icon {
        margin-right: 10px;
        font-size: 1.2rem;
    }
    
    .toast-content {
        flex: 1;
    }
    
    .toast-title {
        font-weight: bold;
        margin-bottom: 3px;
    }
    
    .toast-message {
        font-size: 0.9rem;
    }
    
    .toast-success {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
    }
    
    .toast-warning {
        background-color: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
    }
    
    .toast-error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }
    
    .toast-info {
        background-color: #e1f5fe;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }
    
    @keyframes toast-slide-in {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes toast-slide-out {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    /* Disabled button style */
    .btn-primary:disabled,
    .btn-warning:disabled,
    .btn-success:disabled,
    .btn-small:disabled,
    .btn-disabled {
        background-color: #a9a9a9 !important;
        color: #f5f5f5 !important;
        cursor: not-allowed !important;
        opacity: 0.7;
        box-shadow: none;
        border: 1px solid #999;
    }

    .btn-primary:disabled:hover,
    .btn-warning:disabled:hover,
    .btn-success:disabled:hover,
    .btn-small:disabled:hover,
    .btn-disabled:hover {
        background-color: #a9a9a9 !important;
    }

    /* Confirm dialog styles */
    .confirm-dialog-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 3000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    
    .confirm-dialog-container.active {
        opacity: 1;
        visibility: visible;
    }
    
    .confirm-dialog {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        transform: translateY(-20px);
        transition: transform 0.3s;
    }
    
    .confirm-dialog-container.active .confirm-dialog {
        transform: translateY(0);
    }
    
    .confirm-dialog-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }
    
    .confirm-dialog-message {
        margin-bottom: 20px;
        color: #555;
    }
    
    .confirm-dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    .confirm-dialog-cancel {
        padding: 8px 16px;
        background-color: #f1f1f1;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        color: #333;
    }
    
    .confirm-dialog-confirm {
        padding: 8px 16px;
        background-color: #dc3545;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        color: white;
    }
    
    .confirm-dialog-confirm.confirm-primary {
        background-color: #3498db;
    }
    
    .confirm-dialog-confirm.confirm-warning {
        background-color: #e74c3c;
    }

    /* Bookings section UI fixes */
    .bookings-section {
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .bookings-section .filter-section,
    .bookings-section .sort-section,
    .bookings-section .pagination-controls,
    .bookings-section .bookings-table {
        margin: 0 0.5rem;
    }

    /* Bookings table scroll and word-break fixes */
    .bookings-section .bookings-table {
        overflow-x: auto;
        margin: 0 0.5rem;
    }
    .bookings-section .bookings-table table {
        width: 100%;
        min-width: 800px; /* ensure full columns visible */
        border-collapse: collapse;
    }
    .bookings-section .bookings-table table th,
    .bookings-section .bookings-table table td {
        word-break: break-word;
        overflow-wrap: break-word;
    }

    /* Warning box styling */
    .warning-box {
        background-color: #fff3cd;
        color: #856404;
        padding: 12px;
        margin-bottom: 15px;
        border-left: 4px solid #ffc107;
        border-radius: 4px;
        display: flex;
        align-items: center;
        font-size: 14px;
    }
    
    .warning-box i {
        margin-right: 10px;
        font-size: 18px;
        color: #ffc107;
    }
    
    /* Disabled form fields */
    select:disabled, input:disabled {
        background-color: #f8f9fa;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .password-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .password-wrapper input {
        width: 100%;
        padding-right: 40px; /* Make space for the icon */
    }

    .password-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #888;
    }
</style>

<!-- Confirm Dialog HTML -->
<div class="confirm-dialog-container" id="confirm-dialog-container">
    <div class="confirm-dialog">
        <div class="confirm-dialog-title" id="confirm-dialog-title">Confirm Action</div>
        <div class="confirm-dialog-message" id="confirm-dialog-message">Are you sure you want to proceed?</div>
        <div class="confirm-dialog-actions">
            <button class="confirm-dialog-cancel" id="confirm-dialog-cancel">Cancel</button>
            <button class="confirm-dialog-confirm" id="confirm-dialog-confirm">Confirm</button>
        </div>
    </div>
</div>

// Booking Details Modal
<div id="booking-details-modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.5);">
  <div style="background:#fff;margin:5% auto;padding:1.5rem;border-radius:8px;max-width:500px;position:relative;">
    <span id="booking-details-close" style="position:absolute;top:10px;right:15px;font-size:1.5rem;cursor:pointer;">&times;</span>
    <h3>Booking Details</h3>
    <div id="booking-details-body"></div>
  </div>
</div>

<script>
    // Function to show toast notifications - moving this outside the DOMContentLoaded event
    // so it can be used globally across all event handlers
    function showToast(type, title, message, duration = 5000) {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container';
            document.body.appendChild(toastContainer);
        }
        
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        let icon = '';
        switch(type) {
            case 'success': icon = '‚úì'; break;
            case 'warning': icon = '‚ö†'; break;
            case 'error': icon = '‚úï'; break;
            case 'info': icon = '‚Ñπ'; break;
        }
        
        toast.innerHTML = `
            <div class="toast-icon">${icon}</div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Animation to show toast
        setTimeout(() => {
            // Remove toast after duration
            toast.style.animation = 'toast-slide-out 0.3s forwards';
            setTimeout(() => {
                toastContainer.removeChild(toast);
            }, 300);
        }, duration);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Create toast container if it doesn't exist
        if (!document.querySelector('.toast-container')) {
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container';
            document.body.appendChild(toastContainer);
        }
        
        // Tab navigation for sidebar
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const contentSections = document.querySelectorAll('.content-section');

        sidebarLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all links and sections
                sidebarLinks.forEach(l => l.parentElement.classList.remove('active'));
                contentSections.forEach(section => section.classList.remove('active'));
                
                // Add active class to clicked link
                this.parentElement.classList.add('active');
                
                // Show corresponding section
                const targetId = this.getAttribute('href').substring(1) + '-section';
                document.getElementById(targetId).classList.add('active');
            });
        });
        
        // Modal handling for Members management
        const addMemberBtn = document.getElementById('add-member-btn');
        const addMemberModal = document.getElementById('add-member-modal');
        const editMemberModal = document.getElementById('edit-member-modal');
        const changeRoleModal = document.getElementById('change-role-modal');
        const changePasswordModal = document.getElementById('change-password-modal');
        const changeUsernameModal = document.getElementById('change-username-modal');
        const closeButtons = document.querySelectorAll('.close, .cancel-btn');
        
        // Open Add Member modal
        if (addMemberBtn) {
            addMemberBtn.addEventListener('click', function() {
                addMemberModal.style.display = 'block';
            });
        }
        
        // Close modals when close button or cancel is clicked
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                addMemberModal.style.display = 'none';
                editMemberModal.style.display = 'none';
                changeRoleModal.style.display = 'none';
                changePasswordModal.style.display = 'none';
                changeUsernameModal.style.display = 'none';
                
                // Vehicle modals
                if (addVehicleModal) addVehicleModal.style.display = 'none';
                if (editVehicleModal) editVehicleModal.style.display = 'none';
                if (viewVehicleModal) viewVehicleModal.style.display = 'none';
            });
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === addMemberModal) {
                addMemberModal.style.display = 'none';
            }
            if (event.target === editMemberModal) {
                editMemberModal.style.display = 'none';
            }
            if (event.target === changeRoleModal) {
                changeRoleModal.style.display = 'none';
            }
            if (event.target === changePasswordModal) {
                changePasswordModal.style.display = 'none';
            }
            if (event.target === changeUsernameModal) {
                changeUsernameModal.style.display = 'none';
            }
        });

        // Function to handle the change role form submission
        const changeRoleForm = document.getElementById('change-role-form');
        if (changeRoleForm) {
            changeRoleForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const userId = document.getElementById('change-role-user-id').value;
                const newRole = document.getElementById('change-role-select').value;
                
                try {
                    const res = await fetch('/manager/users/update', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({id: parseInt(userId), role: newRole})
                    });
                    if (res.ok) {
                        showToast('success', 'Role Updated', 'User role has been updated successfully.');
                        changeRoleModal.style.display = 'none';
                        loadUsers();
                    } else {
                        const err = await res.json();
                        showToast('error', 'Update Failed', 'Error updating role: ' + (err.error || res.statusText));
                    }
                } catch (e) {
                    showToast('error', 'Network Error', 'Failed to connect to the server: ' + e);
                }
            });
        }

        // Function to handle the change password form submission
        const changePasswordForm = document.getElementById('change-password-form');
        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const userId = document.getElementById('change-password-user-id').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                // Check that passwords match
                if (newPassword !== confirmPassword) {
                    showToast('error', 'Validation Error', 'Passwords do not match!');
                    return;
                }
                
                try {
                    const res = await fetch('/manager/users/password', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({id: parseInt(userId), password: newPassword})
                    });
                    if (res.ok) {
                        showToast('success', 'Password Updated', 'User password has been updated successfully.');
                        changePasswordModal.style.display = 'none';
                        // Clear the form
                        document.getElementById('new-password').value = '';
                        document.getElementById('confirm-password').value = '';
                    } else {
                        const err = await res.json();
                        showToast('error', 'Update Failed', 'Error updating password: ' + (err.error || res.statusText));
                    }
                } catch (e) {
                    showToast('error', 'Network Error', 'Failed to connect to the server: ' + e);
                }
            });
        }

        // Function to handle the change username form submission
        const changeUsernameForm = document.getElementById('change-username-form');
        if (changeUsernameForm) {
            changeUsernameForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const userId = document.getElementById('change-username-user-id').value;
                const newUsername = document.getElementById('new-username').value;
                
                if (!newUsername || newUsername.trim() === '') {
                    showToast('error', 'Validation Error', 'Username cannot be empty!');
                    return;
                }
                
                try {
                    const res = await fetch('/manager/users/username', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({id: parseInt(userId), username: newUsername})
                    });
                    if (res.ok) {
                        showToast('success', 'Username Updated', 'Username has been updated successfully.');
                        changeUsernameModal.style.display = 'none';
                        loadUsers();
                    } else {
                        const err = await res.json();
                        showToast('error', 'Update Failed', 'Error updating username: ' + (err.error || res.statusText));
                    }
                } catch (e) {
                    showToast('error', 'Network Error', 'Failed to connect to the server: ' + e);
                }
            });
        }

        // Admin dashboard specific functionality
        const memberManagementSection = document.getElementById('members-section');
        if (memberManagementSection) {
            // Function to load users
            function loadUsers() {
                fetch('/manager/users')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(users => {
                        const tbody = document.querySelector('#members-table tbody');
                        if (tbody) {
                            tbody.innerHTML = '';
                            users.forEach(user => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${user.id}</td>
                                    <td>${user.username}</td>
                                    <td>${user.email}</td>
                                    <td>${user.role}</td>
                                    <td>${user.created_at}</td>
                                    <td><span class="status-active">Active</span></td>
                                    <td>
                                        <button class="btn-small edit-user-btn" data-id="${user.id}">Change Role</button>
                                        <button class="btn-small btn-primary change-username-btn" data-id="${user.id}">Change Username</button>
                                        <button class="btn-small btn-success change-password-btn" data-id="${user.id}">Change Password</button>
                                        <button class="btn-small btn-warning delete-user-btn" data-id="${user.id}">Delete</button>
                                    </td>
                                `;
                                tbody.appendChild(row);
                            });
                            
                            // Add event listeners to the new buttons
                            attachUserActionListeners();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading users:', error);
                        showToast('error', 'Loading Error', 'Failed to load users. Please try again later.');
                    });
            }
            
            // Function to attach event listeners for role changes and deletions
            function attachUserActionListeners() {
                // Handle change role button clicks
                document.querySelectorAll('.edit-user-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        const row = this.closest('tr');
                        const username = row.cells[1].textContent;
                        const currentRole = row.cells[3].textContent;
                        
                        // Set values in the modal
                        document.getElementById('change-role-user-id').value = userId;
                        document.getElementById('change-role-username').value = username;
                        document.getElementById('change-role-select').value = currentRole;
                        
                        // Show the modal
                        changeRoleModal.style.display = 'block';
                    });
                });
                
                // Handle change password button clicks
                document.querySelectorAll('.change-password-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        const row = this.closest('tr');
                        const username = row.cells[1].textContent;
                        
                        // Set values in the modal
                        document.getElementById('change-password-user-id').value = userId;
                        document.getElementById('change-password-username').value = username;
                        
                        // Clear any previous password values
                        document.getElementById('new-password').value = '';
                        document.getElementById('confirm-password').value = '';
                        
                        // Show the modal
                        changePasswordModal.style.display = 'block';
                    });
                });

                // Handle change username button clicks
                document.querySelectorAll('.change-username-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        const row = this.closest('tr');
                        const username = row.cells[1].textContent;
                        
                        // Set values in the modal
                        document.getElementById('change-username-user-id').value = userId;
                        document.getElementById('current-username').value = username;
                        document.getElementById('new-username').value = '';
                        
                        // Show the modal
                        changeUsernameModal.style.display = 'block';
                    });
                });

                document.querySelectorAll('.delete-user-btn').forEach(button => {
                    button.addEventListener('click', async function() {
                        const userId = this.getAttribute('data-id');
                        showConfirmDialog('Delete User', 'Are you sure you want to delete this user? This action cannot be undone.', async () => {
                            try {
                                const res = await fetch(`/manager/users/${userId}`, {method: 'DELETE'});
                                if (res.ok) {
                                    showToast('success', 'User Deleted', 'User has been deleted successfully.');
                                    loadUsers();
                                } else {
                                    const err = await res.json();
                                    showToast('error', 'Deletion Failed', 'Error deleting user: ' + (err.error || res.statusText));
                                }
                            } catch (e) {
                                showToast('error', 'Network Error', 'Failed to connect to the server: ' + e);
                            }
                        });
                    });
                });
            }
            
            // Load users when the Manage Members link is clicked
            document.querySelector('a[href="#members"]').addEventListener('click', function() {
                loadUsers();
            });
        }

        // Handle form submissions
        const addMemberForm = document.getElementById('add-member-form');
        if (addMemberForm) {
            addMemberForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('member-name').value;
                const email = document.getElementById('member-email').value;
                const password = document.getElementById('member-password').value;
                const role = document.getElementById('member-role').value;
                
                try {
                    const res = await fetch('/manager/users/create', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username, email, password, role})
                    });
                    if (res.ok) {
                        showToast('success', 'Staff Created', 'New staff member created successfully.');
                        addMemberModal.style.display = 'none';
                        loadUsers();
                        // Clear the form
                        addMemberForm.reset();
                    } else {
                        const err = await res.json();
                        showToast('error', 'Creation Failed', 'Error creating staff member: ' + (err.error || res.statusText));
                    }
                } catch (e) {
                    showToast('error', 'Network Error', 'Failed to connect to the server: ' + e);
                }
            });
        }
        
        // Vehicle management functionality
        const vehicleManagementSection = document.getElementById('vehicles-section');
        if (vehicleManagementSection) {
            const addVehicleBtn = document.getElementById('add-vehicle-btn');
            const addVehicleModal = document.getElementById('add-vehicle-modal');
            const editVehicleModal = document.getElementById('edit-vehicle-modal');
            const viewVehicleModal = document.getElementById('view-vehicle-modal');
            const addVehicleForm = document.getElementById('add-vehicle-form');
            const editVehicleForm = document.getElementById('edit-vehicle-form');
            const detailEditBtn = document.getElementById('detail-edit-btn');
            // Capacity limits per vehicle type
            const vehicleTypeSelect = document.getElementById('vehicle-type');
            const vehicleCapacityInput = document.getElementById('vehicle-capacity');
            const editVehicleTypeSelect = document.getElementById('edit-vehicle-type');
            const editVehicleCapacityInput = document.getElementById('edit-vehicle-capacity');
            const vehicleCapacityLimits = { 'Bus': 60, 'Mini Bus': 25 };
            function updateVehicleCapacityLimit(typeSelect, capInput) {
                const max = vehicleCapacityLimits[typeSelect.value] || 500;
                const min = 1;
                capInput.min = min;
                capInput.max = max;
                capInput.title = `Capacity must be between ${min} and ${max}`;
            }
            
            // Initialize capacity limits based on selected type
            if (vehicleTypeSelect && vehicleCapacityInput) {
                updateVehicleCapacityLimit(vehicleTypeSelect, vehicleCapacityInput);
                vehicleTypeSelect.addEventListener('change', function() {
                    updateVehicleCapacityLimit(this, vehicleCapacityInput);
                });
            }
            if (editVehicleTypeSelect && editVehicleCapacityInput) {
                updateVehicleCapacityLimit(editVehicleTypeSelect, editVehicleCapacityInput);
                editVehicleTypeSelect.addEventListener('change', function() {
                    updateVehicleCapacityLimit(this, editVehicleCapacityInput);
                });
            }
            
            // Function to load vehicles
            function loadVehicles() {
                fetch('/manager/vehicles')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(vehicles => {
                        const tbody = document.querySelector('#vehicles-table tbody');
                        if (tbody) {
                            tbody.innerHTML = '';
                            if (!vehicles || vehicles.length === 0) {
                                // No vehicles found, display a message
                                const row = document.createElement('tr');
                                row.innerHTML = `<td colspan="8" style="text-align: center; padding: 20px;">No vehicles found. Add a new vehicle to get started.</td>`;
                                tbody.appendChild(row);
                                return;
                            }
                            
                            vehicles.forEach(vehicle => {
                                const row = document.createElement('tr');
                                
                                // Format status with appropriate class
                                let statusClass = 'status-active';
                                if (vehicle.status === 'On a trip') {
                                    statusClass = 'status-pending';
                                } else if (vehicle.status === 'Under repair') {
                                    statusClass = 'status-inactive';
                                }
                                
                                row.innerHTML = `
                                    <td>${vehicle.id}</td>
                                    <td>${vehicle.vehicle_number}</td>
                                    <td>${vehicle.type}</td>
                                    <td>${vehicle.capacity}</td>
                                    <td><span class="${statusClass}">${vehicle.status}</span></td>
                                    <td>${vehicle.last_maintenance || 'N/A'}</td>
                                    <td>${vehicle.next_maintenance || 'N/A'}</td>
                                    <td>
                                        <button class="btn-small btn-primary edit-vehicle-btn" data-id="${vehicle.id}">Edit</button>
                                        <button class="btn-small btn-warning delete-vehicle-btn" data-id="${vehicle.id}">Delete</button>
                                    </td>
                                `;
                                tbody.appendChild(row);
                            });
                            
                            // Add event listeners to the new buttons
                            attachVehicleActionListeners();
                            // Populate vehicle type filter dropdown
                            const typeSelect = document.getElementById('filter-vehicle-type');
                            if (typeSelect) {
                                const types = [...new Set(vehicles.map(v => v.type))];
                                while (typeSelect.options.length > 1) typeSelect.remove(1);
                                types.forEach(t => {
                                    const opt = document.createElement('option');
                                    opt.value = t;
                                    opt.textContent = t;
                                    typeSelect.appendChild(opt);
                                });
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading vehicles:', error);
                        const tbody = document.querySelector('#vehicles-table tbody');
                        if (tbody) {
                            tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px; color: #e74c3c;">
                                Error loading vehicles. Please try again later or contact support.
                            </td></tr>`;
                        }
                        // Don't show alert, just log to console
                    });
            }
            
            // Function to attach event listeners for vehicle actions
            function attachVehicleActionListeners() {
                // Edit vehicle
                document.querySelectorAll('.edit-vehicle-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const vehicleId = this.getAttribute('data-id');
                        const row = this.closest('tr');
                        
                        // Set data in the edit modal
                        document.getElementById('edit-vehicle-id').value = vehicleId;
                        document.getElementById('edit-vehicle-number').value = row.cells[1].textContent;
                        document.getElementById('edit-vehicle-type').value = row.cells[2].textContent;
                        document.getElementById('edit-vehicle-capacity').value = row.cells[3].textContent;
                        
                        // Extract status text from the span element
                        const statusSpan = row.cells[4].querySelector('span');
                        document.getElementById('edit-vehicle-status').value = statusSpan ? statusSpan.textContent : '';
                        
                        // Set maintenance dates
                        const lastMaintenance = row.cells[5].textContent;
                        const nextMaintenance = row.cells[6].textContent;
                        
                        document.getElementById('edit-vehicle-last-maintenance').value = 
                            lastMaintenance && lastMaintenance !== 'N/A' ? lastMaintenance : '';
                        document.getElementById('edit-vehicle-next-maintenance').value = 
                            nextMaintenance && nextMaintenance !== 'N/A' ? nextMaintenance : '';
                        
                        // Show the modal
                        editVehicleModal.style.display = 'block';
                    });
                });
                
                // Delete vehicle
                document.querySelectorAll('.delete-vehicle-btn').forEach(button => {
                    button.addEventListener('click', async function() {
                        const vehicleId = this.getAttribute('data-id');
                        showConfirmDialog('Delete Vehicle', 'Are you sure you want to delete this vehicle? This action cannot be undone.', async () => {
                            try {
                                const res = await fetch(`/manager/vehicles/${vehicleId}`, {method: 'DELETE'});
                                if (res.ok) {
                                    showToast('success', 'Vehicle Deleted', 'Vehicle has been deleted successfully.');
                                    loadVehicles();
                                } else {
                                    const err = await res.json();
                                    showToast('error', 'Deletion Failed', 'Error deleting vehicle: ' + (err.error || res.statusText));
                                }
                            } catch (e) {
                                showToast('error', 'Network Error', 'Failed to connect to the server: ' + e);
                            }
                        });
                    });
                });
            }
            
            // Handle edit button in vehicle details view
            if (detailEditBtn) {
                detailEditBtn.addEventListener('click', function() {
                    const vehicleId = this.getAttribute('data-id');
                    
                    // Set data in the edit modal from the detail view
                    document.getElementById('edit-vehicle-id').value = vehicleId;
                    document.getElementById('edit-vehicle-number').value = document.getElementById('detail-vehicle-number').textContent;
                    document.getElementById('edit-vehicle-type').value = document.getElementById('detail-vehicle-type').textContent;
                    document.getElementById('edit-vehicle-capacity').value = document.getElementById('detail-vehicle-capacity').textContent;
                    document.getElementById('edit-vehicle-status').value = document.getElementById('detail-vehicle-status').textContent;
                    
                    const lastMaintenance = document.getElementById('detail-vehicle-last-maintenance').textContent;
                    const nextMaintenance = document.getElementById('detail-vehicle-next-maintenance').textContent;
                    
                    document.getElementById('edit-vehicle-last-maintenance').value = 
                        lastMaintenance && lastMaintenance !== 'N/A' ? lastMaintenance : '';
                    document.getElementById('edit-vehicle-next-maintenance').value = 
                        nextMaintenance && nextMaintenance !== 'N/A' ? nextMaintenance : '';
                    
                    // Close details modal and open edit modal
                    viewVehicleModal.style.display = 'none';
                    editVehicleModal.style.display = 'block';
                });
            }
            
            // Open Add Vehicle modal
            if (addVehicleBtn) {
                addVehicleBtn.addEventListener('click', function() {
                    addVehicleModal.style.display = 'block';
                });
            }
            
            // Make sure cancel buttons close the vehicle modals
            const vehicleCancelBtns = document.querySelectorAll('#add-vehicle-modal .cancel-btn, #edit-vehicle-modal .cancel-btn, #view-vehicle-modal .cancel-btn');
            vehicleCancelBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    addVehicleModal.style.display = 'none';
                    editVehicleModal.style.display = 'none';
                    viewVehicleModal.style.display = 'none';
                });
            });
            
            // Close (X) buttons in vehicle modals
            const vehicleCloseBtns = document.querySelectorAll('#add-vehicle-modal .close, #edit-vehicle-modal .close, #view-vehicle-modal .close');
            vehicleCloseBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    addVehicleModal.style.display = 'none';
                    editVehicleModal.style.display = 'none';
                    viewVehicleModal.style.display = 'none';
                });
            });
            
            // Window click to close vehicle modals
            window.addEventListener('click', function(event) {
                if (event.target === addVehicleModal) {
                    addVehicleModal.style.display = 'none';
                }
                if (event.target === editVehicleModal) {
                    editVehicleModal.style.display = 'none';
                }
                if (event.target === viewVehicleModal) {
                    viewVehicleModal.style.display = 'none';
                }
            });
            
            // Handle form submissions
            if (addVehicleForm) {
                addVehicleForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validate Add Vehicle form inputs
                    const vn = document.getElementById('vehicle-number').value.trim();
                    const capVal = document.getElementById('vehicle-capacity').value;
                    const vmLast = document.getElementById('vehicle-last-maintenance').value;
                    const vmNext = document.getElementById('vehicle-next-maintenance').value;
                    const today = new Date().toISOString().split('T')[0];
                    if (!/^[A-Za-z0-9\- ]{1,20}$/.test(vn)) { showToast('error', 'Validation Error', 'Vehicle number must be 1‚Äì20 alphanumeric characters or hyphens.'); return; }
                    const capNum = parseInt(capVal, 10);
                    const capMin = parseInt(vehicleCapacityInput.min, 10);
                    const capMax = parseInt(vehicleCapacityInput.max, 10);
                    if (isNaN(capNum) || capNum < capMin || capNum > capMax) {
                        showToast('error', 'Validation Error', `Capacity must be between ${capMin} and ${capMax}.`);
                        return;
                    }
                    if (vmLast && vmLast > today) { showToast('error', 'Validation Error', 'Last Maintenance Date cannot be in the future.'); return; }
                    if (vmNext && vmNext < today) { showToast('error', 'Validation Error', 'Next Maintenance Date cannot be in the past.'); return; }
                    if (vmLast && vmNext && vmNext < vmLast) { showToast('error', 'Validation Error', 'Next Maintenance Date must be after Last Maintenance Date.'); return; }
                    
                    // Get form values
                    const vehicleNumber = document.getElementById('vehicle-number').value;
                    const vehicleType = document.getElementById('vehicle-type').value;
                    const capacity = document.getElementById('vehicle-capacity').value;
                    const status = document.getElementById('vehicle-status').value;
                    const lastMaintenance = document.getElementById('vehicle-last-maintenance').value;
                    const nextMaintenance = document.getElementById('vehicle-next-maintenance').value;
                    
                    try {
                        const res = await fetch('/manager/vehicles/create', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                vehicle_number: vehicleNumber,
                                type: vehicleType,
                                capacity: parseInt(capacity),
                                status: status,
                                last_maintenance: lastMaintenance,
                                next_maintenance: nextMaintenance
                            })
                        });
                        
                        if (res.ok) {
                            showToast('success', 'Vehicle Added', 'New vehicle added successfully.');
                            addVehicleModal.style.display = 'none';
                            loadVehicles();
                            // Refresh vehicle options in trip forms
                            if (typeof window.loadVehicleOptions === 'function') {
                                const tripSelect = document.getElementById('trip-vehicle');
                                const editTripSelect = document.getElementById('edit-trip-vehicle');
                                if (tripSelect) window.loadVehicleOptions(tripSelect);
                                if (editTripSelect) window.loadVehicleOptions(editTripSelect);
                            }
                            // Clear the form
                            addVehicleForm.reset();
                        } else {
                            const err = await res.json();
                            const msg = err.error || res.statusText;
                            if (msg.includes('UNIQUE constraint failed: vehicles.vehicle_number')) {
                                showToast('error', 'Addition Failed', 'Vehicle number already exists.');
                            } else {
                                showToast('error', 'Addition Failed', 'Error adding vehicle: ' + msg);
                            }
                        }
                    } catch (e) {
                        showToast('error', 'Network Error', 'Failed to connect to the server: ' + e);
                    }
                });
            }
            
            if (editVehicleForm) {
                editVehicleForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validate Edit Vehicle form inputs
                    const evn = document.getElementById('edit-vehicle-number').value.trim();
                    const ecapVal = document.getElementById('edit-vehicle-capacity').value;
                    const elastMaintenance = document.getElementById('edit-vehicle-last-maintenance').value;
                    const enextMaintenance = document.getElementById('edit-vehicle-next-maintenance').value;
                    const today2 = new Date().toISOString().split('T')[0];
                    if (!/^[A-Za-z0-9\- ]{1,20}$/.test(evn)) { showToast('error', 'Validation Error', 'Vehicle number must be 1‚Äì20 alphanumeric characters or hyphens.'); return; }
                    const ecapNum = parseInt(ecapVal, 10);
                    const ecapMin = parseInt(editVehicleCapacityInput.min, 10);
                    const ecapMax = parseInt(editVehicleCapacityInput.max, 10);
                    if (isNaN(ecapNum) || ecapNum < ecapMin || ecapNum > ecapMax) {
                        showToast('error', 'Validation Error', `Capacity must be between ${ecapMin} and ${ecapMax}.`);
                        return;
                    }
                    if (elastMaintenance && elastMaintenance > today2) { showToast('error', 'Validation Error', 'Last Maintenance Date cannot be in the future.'); return; }
                    if (enextMaintenance && enextMaintenance < today2) { showToast('error', 'Validation Error', 'Next Maintenance Date cannot be in the past.'); return; }
                    if (elastMaintenance && enextMaintenance && enextMaintenance < elastMaintenance) { showToast('error', 'Validation Error', 'Next Maintenance Date must be after Last Maintenance Date.'); return; }
                    
                    // Get form values
                    const vehicleId = document.getElementById('edit-vehicle-id').value;
                    const vehicleNumber = document.getElementById('edit-vehicle-number').value;
                    const vehicleType = document.getElementById('edit-vehicle-type').value;
                    const capacity = document.getElementById('edit-vehicle-capacity').value;
                    const status = document.getElementById('edit-vehicle-status').value;
                    const lastMaintenance = document.getElementById('edit-vehicle-last-maintenance').value;
                    const nextMaintenance = document.getElementById('edit-vehicle-next-maintenance').value;
                    
                    try {
                        const res = await fetch('/manager/vehicles/update', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                id: parseInt(vehicleId),
                                vehicle_number: vehicleNumber,
                                type: vehicleType,
                                capacity: parseInt(capacity),
                                status: status,
                                last_maintenance: lastMaintenance,
                                next_maintenance: nextMaintenance
                            })
                        });
                        
                        if (res.ok) {
                            showToast('success', 'Vehicle Updated', 'Vehicle updated successfully.');
                            editVehicleModal.style.display = 'none';
                            loadVehicles();
                            // Refresh vehicle options in trip forms
                            if (typeof window.loadVehicleOptions === 'function') {
                                const tripSelect = document.getElementById('trip-vehicle');
                                const editTripSelect = document.getElementById('edit-trip-vehicle');
                                if (tripSelect) window.loadVehicleOptions(tripSelect);
                                if (editTripSelect) window.loadVehicleOptions(editTripSelect);
                            }
                        } else {
                            const err = await res.json();
                            const msg = err.error || res.statusText;
                            if (msg.includes('UNIQUE constraint failed: vehicles.vehicle_number')) {
                                showToast('error', 'Update Failed', 'Vehicle number already exists.');
                            } else {
                                showToast('error', 'Update Failed', 'Error updating vehicle: ' + msg);
                            }
                        }
                    } catch (e) {
                        showToast('error', 'Network Error', 'Failed to connect to the server: ' + e);
                    }
                });
            }
            
            // Search functionality
            const vehicleSearch = document.getElementById('vehicle-search');
            if (vehicleSearch) {
                vehicleSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const tableRows = document.querySelectorAll('#vehicles-table tbody tr');
                    
                    tableRows.forEach(row => {
                        const vehicleNumber = row.cells[1].textContent.toLowerCase();
                        const vehicleType = row.cells[2].textContent.toLowerCase();
                        const status = row.cells[4].textContent.toLowerCase();
                        
                        if (vehicleNumber.includes(searchTerm) || 
                            vehicleType.includes(searchTerm) || 
                            status.includes(searchTerm)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }
            
            // Load vehicles when the Manage Vehicles link is clicked
            document.querySelector('a[href="#vehicles"]').addEventListener('click', function() {
                loadVehicles();
            });
        }

        // Trip management functionality
        const tripSection = document.getElementById('trips-section');
        if (tripSection) {
            const addTripBtn = document.getElementById('add-trip-btn');
            const addTripModal = document.getElementById('add-trip-modal');
            const editTripModal = document.getElementById('edit-trip-modal');
            const addTripForm = document.getElementById('add-trip-form');
            const editTripForm = document.getElementById('edit-trip-form');
            const tripOriginSelect = document.getElementById('trip-origin');
            const tripDestinationSelect = document.getElementById('trip-destination');
            const tripVehicleSelect = document.getElementById('trip-vehicle');
            const editTripOrigin = document.getElementById('edit-trip-origin');
            const editTripDestination = document.getElementById('edit-trip-destination');
            const editTripVehicle = document.getElementById('edit-trip-vehicle');

            // Prevent selecting same origin and destination
            if (tripOriginSelect && tripDestinationSelect) {
                // Function to validate and update UI
                function validateOriginDestination(originSelect, destSelect, formSubmitBtn) {
                    if (originSelect.value === destSelect.value && originSelect.value !== '') {
                        // Show error
                        if (!originSelect.classList.contains('error-field')) {
                            originSelect.classList.add('error-field');
                            destSelect.classList.add('error-field');
                            
                            // Add error message if it doesn't exist
                            let errorMsg = originSelect.parentNode.querySelector('.error-message');
                            if (!errorMsg) {
                                errorMsg = document.createElement('div');
                                errorMsg.className = 'error-message';
                                errorMsg.textContent = 'Origin and destination cannot be the same city';
                                errorMsg.style.color = 'red';
                                errorMsg.style.fontSize = '0.8rem';
                                errorMsg.style.marginTop = '5px';
                                originSelect.parentNode.appendChild(errorMsg);
                            }
                        }
                        // Disable submit button
                        if (formSubmitBtn) {
                            formSubmitBtn.disabled = true;
                            formSubmitBtn.style.opacity = '0.5';
                            formSubmitBtn.style.cursor = 'not-allowed';
                        }
                        return false;
                    } else {
                        // Clear error
                        originSelect.classList.remove('error-field');
                        destSelect.classList.remove('error-field');
                        
                        // Remove error message if it exists
                        const errorMsg = originSelect.parentNode.querySelector('.error-message');
                        if (errorMsg) {
                            errorMsg.remove();
                        }
                        
                        // Enable submit button
                        if (formSubmitBtn) {
                            formSubmitBtn.disabled = false;
                            formSubmitBtn.style.opacity = '1';
                            formSubmitBtn.style.cursor = 'pointer';
                        }
                        return true;
                    }
                }
                
                // Get the submit buttons
                const addTripSubmitBtn = document.querySelector('#add-trip-form button[type="submit"]');
                const editTripSubmitBtn = document.querySelector('#edit-trip-form button[type="submit"]');
                
                // Initial validation
                validateOriginDestination(tripOriginSelect, tripDestinationSelect, addTripSubmitBtn);
                
                // Add event listeners
                tripOriginSelect.addEventListener('change', function() {
                    validateOriginDestination(tripOriginSelect, tripDestinationSelect, addTripSubmitBtn);
                });
                
                tripDestinationSelect.addEventListener('change', function() {
                    validateOriginDestination(tripOriginSelect, tripDestinationSelect, addTripSubmitBtn);
                });
            }
            
            // Prevent selecting same origin and destination in edit form
            if (editTripOrigin && editTripDestination) {
                // Initial validation
                const editTripSubmitBtn = document.querySelector('#edit-trip-form button[type="submit"]');
                validateOriginDestination(editTripOrigin, editTripDestination, editTripSubmitBtn);
                
                // Add event listeners
                editTripOrigin.addEventListener('change', function() {
                    validateOriginDestination(editTripOrigin, editTripDestination, editTripSubmitBtn);
                });
                
                editTripDestination.addEventListener('change', function() {
                    validateOriginDestination(editTripOrigin, editTripDestination, editTripSubmitBtn);
                });
            }

            // Fetch vehicles to populate select options - Make this function available to other sections
            window.loadVehicleOptions = async function(selectElem, departure, arrival, currentVehicleID) {
                try {
                    let url = '/manager/vehicles';
                    if (departure && arrival) {
                        url += `?departure=${encodeURIComponent(departure)}&arrival=${encodeURIComponent(arrival)}`;
                    }
                    const res = await fetch(url);
                    if (!res.ok) {
                        console.error('Failed to fetch vehicles');
                        return;
                    }
                const vehicles = await res.json();
                selectElem.innerHTML = '';
                
                // Check if we need to fetch the current vehicle separately
                let currentVehicleIncluded = false;
                if (currentVehicleID) {
                    currentVehicleIncluded = vehicles.some(v => v.id == currentVehicleID);
                }
                
                // If we have a currentVehicleID that's not in the list, fetch it separately
                let currentVehicle = null;
                if (currentVehicleID && !currentVehicleIncluded) {
                    try {
                        const currentRes = await fetch(`/manager/vehicles/${currentVehicleID}`);
                        if (currentRes.ok) {
                            currentVehicle = await currentRes.json();
                        }
                    } catch (err) {
                        console.error('Error fetching current vehicle:', err);
                    }
                }
                
                // Add the current vehicle as the first option if it exists and isn't already included
                if (currentVehicle) {
                    const opt = document.createElement('option');
                    opt.value = currentVehicle.id;
                    opt.textContent = `${currentVehicle.vehicle_number} (Current Assignment)`;
                    opt.selected = true;
                    selectElem.appendChild(opt);
                }
                
                // Add all available vehicles
                vehicles.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.id;
                    opt.textContent = v.vehicle_number;
                    if (currentVehicleID && v.id == currentVehicleID) {
                        opt.selected = true;
                    }
                    selectElem.appendChild(opt);
                });
                
                // Return the current vehicle ID so it can be used by callers
                return currentVehicleID;
                } catch (err) {
                    console.error('Error loading vehicle options:', err);
                    return null;
                }
            }
            
            // Initialize vehicle dropdowns (no filter by default)
            window.loadVehicleOptions(tripVehicleSelect);
            window.loadVehicleOptions(editTripVehicle);
            // Reload vehicle options when departure/arrival change
            if (tripVehicleSelect) {
                const addDep = document.getElementById('trip-departure');
                const addArr = document.getElementById('trip-arrival');
                function refreshAddVehicles() {
                    const dep = addDep.value;
                    const arr = addArr.value;
                    if (dep && arr) {
                        window.loadVehicleOptions(tripVehicleSelect, dep, arr);
                    }
                }
                addDep.addEventListener('change', refreshAddVehicles);
                addArr.addEventListener('change', refreshAddVehicles);
            }
            if (editTripVehicle) {
                const editDep = document.getElementById('edit-trip-departure');
                const editArr = document.getElementById('edit-trip-arrival');
                function refreshEditVehicles() {
                    const dep = editDep.value;
                    const arr = editArr.value;
                    if (dep && arr) {
                        window.loadVehicleOptions(editTripVehicle, dep, arr);
                    }
                }
                editDep.addEventListener('change', refreshEditVehicles);
                editArr.addEventListener('change', refreshEditVehicles);
            }

            function loadTrips() {
                fetch('/manager/trips')
                    .then(res => res.json())
                    .then(trips => {
                        const tbody = document.querySelector('#trips-table tbody');
                        tbody.innerHTML = '';
                        trips.forEach(t => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${t.id}</td>
                                <td>${t.origin}</td>
                                <td>${t.destination}</td>
                                <td>${t.vehicle_number}</td>
                                <td>${t.departure_time}</td>
                                <td>${t.arrival_time}</td>
                                <td>
                                    <button class="btn-small edit-trip-btn" data-id="${t.id}">Edit</button>
                                    <button class="btn-small btn-warning delete-trip-btn" data-id="${t.id}">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                        attachTripListeners();
                        
                        // After loading trips, refresh trip options in booking forms
                        if (typeof window.loadTripOptions === 'function') {
                            const bookingTripSelect = document.getElementById('booking-trip');
                            const editBookingTrip = document.getElementById('edit-booking-trip');
                            if (bookingTripSelect) window.loadTripOptions(bookingTripSelect);
                            if (editBookingTrip) window.loadTripOptions(editBookingTrip);
                        }
                        // Populate filter dropdowns for trips
                        const origins = [...new Set(trips.map(t => t.origin))];
                        const destinations = [...new Set(trips.map(t => t.destination))];
                        const vehicles = [...new Set(trips.map(t => t.vehicle_number))];
                        const originFilter = document.getElementById('filter-trip-origin');
                        const destFilter = document.getElementById('filter-trip-destination');
                        const vehicleFilter = document.getElementById('filter-trip-vehicle');
                        // Clear existing options except the first
                        while (originFilter.options.length > 1) originFilter.remove(1);
                        while (destFilter.options.length > 1) destFilter.remove(1);
                        while (vehicleFilter.options.length > 1) vehicleFilter.remove(1);
                        origins.forEach(o => {
                            const opt = document.createElement('option'); opt.value = o; opt.textContent = o; originFilter.appendChild(opt);
                        });
                        destinations.forEach(d => {
                            const opt = document.createElement('option'); opt.value = d; opt.textContent = d; destFilter.appendChild(opt);
                        });
                        vehicles.forEach(v => {
                            const opt = document.createElement('option'); opt.value = v; opt.textContent = v; vehicleFilter.appendChild(opt);
                        });
                    });
            }

            function attachTripListeners() {
                document.querySelectorAll('.edit-trip-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        fetch(`/manager/trips`)
                            .then(r => r.json())
                            .then(trips => {
                                const trip = trips.find(x => x.id == id);
                                if (trip) {
                                    document.getElementById('edit-trip-id').value = trip.id;
                                    editTripOrigin.value = trip.origin;
                                    editTripDestination.value = trip.destination;
                                    const initialDeparture = trip.departure_time;
                                    const initialArrival = trip.arrival_time;
                                    document.getElementById('edit-trip-departure').value = initialDeparture;
                                    document.getElementById('edit-trip-arrival').value = initialArrival;

                                    // Load vehicle options based on these initial dates, then select current vehicle
                                    if (initialDeparture && initialArrival) {
                                        if (new Date(initialDeparture) >= new Date(initialArrival)) {
                                            editTripVehicle.innerHTML = '<option value="">Invalid current trip dates</option>';
                                        } else {
                                            window.loadVehicleOptions(editTripVehicle, initialDeparture, initialArrival, trip.vehicle_id);
                                        }
                                    } else {
                                        window.loadVehicleOptions(editTripVehicle, null, null, trip.vehicle_id);
                                    }
                                    
                                    // Check if trip has bookings to lock origin/destination
                                    fetch(`/manager/trips/${id}/capacity`)
                                        .then(r => r.json())
                                        .then(data => {
                                            const warningElement = document.getElementById('edit-trip-booking-warning');
                                            if (data.booked > 0) {
                                                // Lock origin and destination fields
                                                editTripOrigin.disabled = true;
                                                editTripDestination.disabled = true;
                                                
                                                // Show warning message
                                                if (warningElement) {
                                                    warningElement.style.display = 'block';
                                                    warningElement.innerHTML = 
                                                        `<div class="warning-box">
                                                            <i class="fas fa-exclamation-triangle"></i>
                                                            This trip has ${data.booked} active booking(s). Origin and destination cannot be modified.
                                                            You must cancel all bookings first to change these fields.
                                                         </div>`;
                                                }
                                            } else {
                                                // Enable fields if no bookings
                                                editTripOrigin.disabled = false;
                                                editTripDestination.disabled = false;
                                                
                                                // Hide warning
                                                if (warningElement) {
                                                    warningElement.style.display = 'none';
                                                }
                                            }
                                        })
                                        .catch(err => {
                                            console.error("Error checking trip capacity:", err);
                                        });
                                    
                                    editTripModal.style.display = 'block';
                                }
                            });
                    });
                });
                document.querySelectorAll('.delete-trip-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        showConfirmDialog('Delete Trip', 'Are you sure you want to delete this trip? This action cannot be undone.', async () => {
                            fetch(`/manager/trips/${id}`, {method:'DELETE'})
                                .then(r=>{ if(r.ok) loadTrips(); });
                        });
                    });
                });
            }

            // Add event listeners for date changes in Edit Trip modal
            const editTripDepInput = document.getElementById('edit-trip-departure');
            const editTripArrInput = document.getElementById('edit-trip-arrival');

            function refreshEditModalVehicleOptions() {
                const dep = editTripDepInput.value;
                const arr = editTripArrInput.value;
                // Get the current vehicle ID if available
                const currentVehicleID = editTripVehicle.value ? parseInt(editTripVehicle.value) : null;
                
                if (dep && arr) {
                    if (new Date(dep) >= new Date(arr)) {
                        showToast('error', 'Validation Error', 'Departure time must be before arrival time.');
                        editTripVehicle.innerHTML = '<option value="">Invalid dates: Dep ‚â• Arr</option>';
                        return;
                    }
                    window.loadVehicleOptions(editTripVehicle, dep, arr, currentVehicleID);
                } else {
                    editTripVehicle.innerHTML = '<option value="">Select departure & arrival</option>';
                }
            }

            if (editTripDepInput && editTripArrInput && editTripVehicle) {
                editTripDepInput.addEventListener('change', refreshEditModalVehicleOptions);
                editTripArrInput.addEventListener('change', refreshEditModalVehicleOptions);
            }

            // Add Trip modal
            addTripBtn.addEventListener('click', ()=> {
                // Reset the form to ensure default values are used
                addTripForm.reset();
                
                // Set default values for origin and destination
                tripOriginSelect.value = 'Tehran';
                tripDestinationSelect.value = 'Mashhad';
                
                // Update vehicle options based on default dates if they exist
                const departureTime = document.getElementById('trip-departure').value;
                const arrivalTime = document.getElementById('trip-arrival').value;
                if (departureTime && arrivalTime) {
                    window.loadVehicleOptions(tripVehicleSelect, departureTime, arrivalTime);
                } else {
                    window.loadVehicleOptions(tripVehicleSelect);
                }
                
                // Run validation to ensure form starts in a valid state
                validateOriginDestination(tripOriginSelect, tripDestinationSelect, 
                    document.querySelector('#add-trip-form button[type="submit"]'));
                
                // Show the modal
                addTripModal.style.display='block';
            });
            document.querySelectorAll('#add-trip-modal .cancel-btn, #add-trip-modal .close').forEach(b=>b.addEventListener('click', ()=>addTripModal.style.display='none'));
            window.addEventListener('click', e=>{ if(e.target===addTripModal) addTripModal.style.display='none'; });

            addTripForm.addEventListener('submit', async e=>{
                e.preventDefault();
                const departureTime = document.getElementById('trip-departure').value;
                const arrivalTime = document.getElementById('trip-arrival').value;
                const origin = tripOriginSelect.value;
                const destination = tripDestinationSelect.value;

                // Validate origin and destination are not the same
                if (origin === destination) {
                    validateOriginDestination(tripOriginSelect, tripDestinationSelect, 
                        document.querySelector('#add-trip-form button[type="submit"]'));
                    return; // Stop form submission
                }

                if (new Date(departureTime) >= new Date(arrivalTime)) {
                    showToast('error', 'Validation Error', 'Departure time must be before arrival time.');
                    return;
                }

                const res = await fetch('/manager/trips/create', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
                    origin: origin,
                    destination: destination,
                    vehicle_id: parseInt(tripVehicleSelect.value),
                    departure_time: departureTime,
                    arrival_time: arrivalTime
                })});
                if(res.ok){ 
                    addTripModal.style.display='none'; 
                    loadTrips(); 
                }
            });

            // Add event listeners for date changes in Add Trip modal for validation
            const addTripDepInput = document.getElementById('trip-departure');
            const addTripArrInput = document.getElementById('trip-arrival');
            
            function validateAddTripDates() {
                const dep = addTripDepInput.value;
                const arr = addTripArrInput.value;
                if (dep && arr && new Date(dep) >= new Date(arr)) {
                    showToast('error', 'Validation Error', 'Departure time must be before arrival time.');
                     // Optionally, clear the vehicle select or disable submit
                }
            }

            if (addTripDepInput && addTripArrInput) {
                addTripDepInput.addEventListener('change', validateAddTripDates);
                addTripArrInput.addEventListener('change', validateAddTripDates);
            }

            // Edit Trip modal
            document.querySelectorAll('#edit-trip-modal .cancel-btn, #edit-trip-modal .close').forEach(b=>b.addEventListener('click', ()=>editTripModal.style.display='none'));
            window.addEventListener('click', e=>{ if(e.target===editTripModal) editTripModal.style.display='none'; });
            editTripForm.addEventListener('submit', async e=>{
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-trip-id').value);
                const origin = editTripOrigin.value;
                const destination = editTripDestination.value;
                const departure = document.getElementById('edit-trip-departure').value;
                const arrival = document.getElementById('edit-trip-arrival').value;
                
                // Validate origin and destination are not the same
                if (origin === destination) {
                    validateOriginDestination(editTripOrigin, editTripDestination, 
                        document.querySelector('#edit-trip-form button[type="submit"]'));
                    return; // Stop form submission
                }
                
                // Validate departure is before arrival
                if (new Date(departure) >= new Date(arrival)) {
                    showToast('error', 'Validation Error', 'Departure time must be before arrival time.');
                    return;
                }
                
                const res = await fetch('/manager/trips/update', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
                    id,
                    origin: origin,
                    destination: destination,
                    vehicle_id: parseInt(editTripVehicle.value),
                    departure_time: departure,
                    arrival_time: arrival
                })});
                if (res.ok) {
                    editTripModal.style.display='none';
                    loadTrips();
                } else {
                    const err = await res.json();
                    showToast('error', 'Update Failed', 'Error updating trip: ' + (err.error || res.statusText));
                }
            });

            // Search trips
            document.getElementById('trip-search').addEventListener('input', function(){
                const term=this.value.toLowerCase();
                document.querySelectorAll('#trips-table tbody tr').forEach(r=>{
                    r.style.display = ([...r.cells].slice(1,4).map(c=>c.textContent.toLowerCase()).join(' ')).includes(term)?'':'none';
                });
            });

            // Load when clicked
            document.querySelector('a[href="#trips"]').addEventListener('click', function() {
                // Refresh vehicle options for trip forms
                if (typeof window.loadVehicleOptions === 'function') {
                    const tripSelect = document.getElementById('trip-vehicle');
                    const editTripSelect = document.getElementById('edit-trip-vehicle');
                    if (tripSelect) window.loadVehicleOptions(tripSelect);
                    if (editTripSelect) window.loadVehicleOptions(editTripSelect);
                }
                loadTrips();
            });

            // Trip filter apply handler
            document.getElementById('trip-filter-apply').addEventListener('click', function() {
                const origin = document.getElementById('filter-trip-origin').value;
                const destination = document.getElementById('filter-trip-destination').value;
                const vehicle = document.getElementById('filter-trip-vehicle').value;
                const depFrom = document.getElementById('filter-departure-from').value;
                const depTo = document.getElementById('filter-departure-to').value;
                const arrFrom = document.getElementById('filter-arrival-from').value;
                const arrTo = document.getElementById('filter-arrival-to').value;
                document.querySelectorAll('#trips-table tbody tr').forEach(row => {
                    const cells = row.cells;
                    const o = cells[1].textContent;
                    const d = cells[2].textContent;
                    const v = cells[3].textContent;
                    const dep = cells[4].textContent;
                    const arr = cells[5].textContent;
                    let show = true;
                    if (origin && o !== origin) show = false;
                    if (destination && d !== destination) show = false;
                    if (vehicle && v !== vehicle) show = false;
                    if (depFrom && new Date(dep) < new Date(depFrom)) show = false;
                    if (depTo && new Date(dep) > new Date(depTo)) show = false;
                    if (arrFrom && new Date(arr) < new Date(arrFrom)) show = false;
                    if (arrTo && new Date(arr) > new Date(arrTo)) show = false;
                    row.style.display = show ? '' : 'none';
                });
            });
            // Trip filter reset handler
            document.getElementById('trip-filter-reset').addEventListener('click', function() {
                document.getElementById('filter-trip-origin').value = '';
                document.getElementById('filter-trip-destination').value = '';
                document.getElementById('filter-trip-vehicle').value = '';
                document.getElementById('filter-departure-from').value = '';
                document.getElementById('filter-departure-to').value = '';
                document.getElementById('filter-arrival-from').value = '';
                document.getElementById('filter-arrival-to').value = '';
                loadTrips();
            });
        }

        // Booking management functionality
        const bookingSection = document.getElementById('bookings-section');
        if (bookingSection) {
            // Pagination state
            const pageSizeSelect = document.getElementById('page-size-select');
            let currentPage = 1;
            let pageSize = pageSizeSelect ? parseInt(pageSizeSelect.value) : 10;
            let totalPages = 1;
            let currentFilters = {};
            let currentSortBy = '';
            let currentSortDir = '';
            // Update page size
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', function() {
                    pageSize = parseInt(this.value);
                    currentPage = 1;
                    loadBookings(currentFilters, currentSortBy, currentSortDir);
                });
            }
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', function() {
                    if (currentPage > 1) {
                        currentPage--;
                        loadBookings(currentFilters, currentSortBy, currentSortDir);
                    }
                });
            }
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', function() {
                    if (currentPage < totalPages) {
                        currentPage++;
                        loadBookings(currentFilters, currentSortBy, currentSortDir);
                    }
                });
            }
            const addBookingBtn = document.getElementById('add-booking-btn');
            const addBookingModal = document.getElementById('add-booking-modal');
            const editBookingModal = document.getElementById('edit-booking-modal');
            const addBookingForm = document.getElementById('add-booking-form');
            const editBookingForm = document.getElementById('edit-booking-form');
            const bookingTripSelect = document.getElementById('booking-trip');
            const editBookingTrip = document.getElementById('edit-booking-trip');

            // Populate trips for bookings - Make this function available to other sections
            window.loadTripOptions = async function(selectElem) {
                try {
                    const res = await fetch('/manager/trips');
                    if (!res.ok) {
                        console.error('Failed to fetch trips');
                        return;
                    }
                    const trips = await res.json();
                    selectElem.innerHTML = '';
                    trips.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.id;
                        opt.textContent = `${t.origin} ‚Üí ${t.destination} (${t.departure_time})`;
                        selectElem.appendChild(opt);
                    });
                    // Update capacity info when the selected trip changes
                    selectElem.addEventListener('change', () => updateTripCapacityInfo(selectElem.value));
                    // Initial capacity check for the current selection
                    if (selectElem.value) {
                        updateTripCapacityInfo(selectElem.value);
                    }
                } catch (err) {
                    console.error('Error loading trip options:', err);
                }
            }
            
            // Function to update capacity information for a selected trip
            async function updateTripCapacityInfo(tripId, showNotifications = false) {
                try {
                    const capacityInfo = document.getElementById('trip-capacity-info');
                    if (!capacityInfo) return;
                    
                    // Clear previous info
                    capacityInfo.innerHTML = '<span class="loading">Loading capacity info...</span>';
                    
                    // Exit if no trip selected
                    if (!tripId) {
                        capacityInfo.innerHTML = '<span class="capacity-unknown">No trip selected</span>';
                        return;
                    }
                    
                    // Fetch trip capacity and booking count
                    const res = await fetch(`/manager/trips/${tripId}/capacity`);
                    if (!res.ok) {
                        capacityInfo.innerHTML = '<span class="error">Error checking capacity</span>';
                        return;
                    }
                    
                    const data = await res.json();
                    const { capacity, booked, available, is_available } = data;
                    
                    let statusClass = is_available ? 'available' : 'full';
                    let statusText = is_available ? 'Available' : 'FULL';
                    
                    // Add progress bar for visual capacity indicator
                    const percentFull = Math.min(100, Math.round((booked / capacity) * 100));
                    let barColor = '#28a745'; // Green for available
                    
                    if (percentFull >= 90) {
                        barColor = '#dc3545'; // Red for nearly full or full
                    } else if (percentFull >= 75) {
                        barColor = '#ffc107'; // Yellow for getting full
                    }
                    
                    capacityInfo.innerHTML = `
                        <div class="capacity-details">
                            <div style="width: 100%; margin-bottom: 8px;">
                                <div style="height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${percentFull}%; background-color: ${barColor}; border-radius: 4px;"></div>
                                </div>
                            </div>
                            <span class="capacity-total">Total Capacity: ${capacity}</span>
                            <span class="capacity-booked">Booked: ${booked}</span>
                            <span class="capacity-available">Available: ${available}</span>
                            <span class="capacity-status ${statusClass}">${statusText}</span>
                        </div>
                    `;
                    
                    // Disable/enable the submit button if trip is full
                    const submitBtn = document.querySelector('#add-booking-form button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = !is_available;
                        
                        if (!is_available) {
                            submitBtn.title = 'This trip is fully booked';
                            submitBtn.classList.add('btn-disabled');
                            
                            // Only show toast notification when requested (e.g., when user selects a trip)
                            if (showNotifications) {
                                showToast('error', 'Trip Fully Booked', 
                                        'This trip has reached its maximum capacity. Please select another trip.', 
                                        7000);
                            }
                        } else {
                            submitBtn.title = '';
                            submitBtn.classList.remove('btn-disabled');
                            
                            // Only show toast notification when requested
                            if (showNotifications && available <= 5) {
                                showToast('warning', 'Trip Almost Full', 
                                        `Only ${available} seat${available === 1 ? '' : 's'} remaining on this trip.`, 
                                        5000);
                            }
                        }
                    }
                } catch (err) {
                    console.error('Error fetching trip capacity:', err);
                    document.getElementById('trip-capacity-info').innerHTML = 
                        '<span class="error">Error checking capacity</span>';
                }
            }
            
            // Same function for edit modal
            async function updateEditTripCapacityInfo(tripId, showNotifications = false) {
                try {
                    const capacityInfo = document.getElementById('edit-trip-capacity-info');
                    if (!capacityInfo) return;
                    
                    // Clear previous info
                    capacityInfo.innerHTML = '<span class="loading">Loading capacity info...</span>';
                    
                    // Exit if no trip selected
                    if (!tripId) {
                        capacityInfo.innerHTML = '<span class="capacity-unknown">No trip selected</span>';
                        return;
                    }
                    
                    // Fetch trip capacity and booking count
                    const res = await fetch(`/manager/trips/${tripId}/capacity`);
                    if (!res.ok) {
                        capacityInfo.innerHTML = '<span class="error">Error checking capacity</span>';
                        return;
                    }
                    
                    const data = await res.json();
                    const { capacity, booked, available, is_available } = data;
                    
                    let statusClass = is_available ? 'available' : 'full';
                    let statusText = is_available ? 'Available' : 'FULL';
                    
                    // Add progress bar for visual capacity indicator
                    const percentFull = Math.min(100, Math.round((booked / capacity) * 100));
                    let barColor = '#28a745'; // Green for available
                    
                    if (percentFull >= 90) {
                        barColor = '#dc3545'; // Red for nearly full or full
                    } else if (percentFull >= 75) {
                        barColor = '#ffc107'; // Yellow for getting full
                    }
                    
                    capacityInfo.innerHTML = `
                        <div class="capacity-details">
                            <div style="width: 100%; margin-bottom: 8px;">
                                <div style="height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${percentFull}%; background-color: ${barColor}; border-radius: 4px;"></div>
                                </div>
                            </div>
                            <span class="capacity-total">Total Capacity: ${capacity}</span>
                            <span class="capacity-booked">Booked: ${booked}</span>
                            <span class="capacity-available">Available: ${available}</span>
                            <span class="capacity-status ${statusClass}">${statusText}</span>
                        </div>
                    `;
                    
                    // Only show notifications when explicitly requested
                    if (showNotifications && !is_available) {
                        showToast('error', 'Trip Fully Booked', 
                                'This trip has reached its maximum capacity.', 
                                7000);
                    }
                } catch (err) {
                    console.error('Error fetching trip capacity:', err);
                    document.getElementById('edit-trip-capacity-info').innerHTML = 
                        '<span class="error">Error checking capacity</span>';
                }
            }
            
            // Initialize trip dropdowns
            window.loadTripOptions(bookingTripSelect);
            window.loadTripOptions(editBookingTrip);
            
            // Add event listeners with showNotifications flag
            if (bookingTripSelect) {
                bookingTripSelect.addEventListener('change', function() {
                    updateTripCapacityInfo(this.value, true); // Only show notifications on explicit user selection
                });
            }
            
            if (editBookingTrip) {
                editBookingTrip.addEventListener('change', function() {
                    updateEditTripCapacityInfo(this.value, true); // Only show notifications on explicit user selection
                });
            }

            // Load bookings with filter support
            async function loadBookings(filters = {}, sortBy = '', sortDir = '') {
                // Update current filter and sort state
                currentFilters = filters;
                currentSortBy = sortBy;
                currentSortDir = sortDir;
                // Build query string
                const queryParams = new URLSearchParams();
                if (filters.passenger) queryParams.append('passenger', filters.passenger);
                if (filters.origin) queryParams.append('origin', filters.origin);
                if (filters.destination) queryParams.append('destination', filters.destination);
                if (filters.status) queryParams.append('status', filters.status);
                if (filters.date_from) queryParams.append('date_from', filters.date_from);
                if (filters.date_to) queryParams.append('date_to', filters.date_to);
                if (sortBy) queryParams.append('sort_by', sortBy);
                if (sortDir) queryParams.append('sort_dir', sortDir);
                // Add pagination parameters
                queryParams.append('page', currentPage);
                queryParams.append('page_size', pageSize);
                
                const queryString = queryParams.toString();
                const url = `/manager/bookings${queryString ? '?' + queryString : ''}`;
                
                const res = await fetch(url);
                const data = await res.json();
                const bookings = data.bookings || [];
                const totalCount = data.total || bookings.length;
                totalPages = Math.ceil(totalCount / pageSize);
                
                const table = document.querySelector('.bookings-table');
                if (!bookings || bookings.length === 0) {
                    table.innerHTML = '<p>No bookings found.</p>';
                    return;
                }
                
                // Build table
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Passenger</th>
                                <th>Origin</th>
                                <th>Destination</th>
                                <th>Booking Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                bookings.forEach(b => {
                    html += `
                        <tr>
                            <td>${b.id}</td>
                            <td>${b.passenger}</td>
                            <td>${b.origin}</td>
                            <td>${b.destination}</td>
                            <td>${b.booking_date}</td>
                            <td>${b.status}</td>
                            <td>
                                <button class="btn-small btn-info view-booking-btn"
                                        data-id="${b.id}"
                                        data-passenger="${b.passenger}"
                                        data-origin="${b.origin}"
                                        data-destination="${b.destination}"
                                        data-social-id="${b.social_id || ''}"
                                        data-phone="${b.phone_number || ''}"
                                        data-dob="${b.date_of_birth || ''}"
                                        data-booking-date="${b.booking_date}"
                                        data-status="${b.status}">
                                    Details
                                </button>
                                <button class="btn-small edit-booking"
                                        data-id="${b.id}"
                                        data-trip-id="${b.trip_id}"
                                        data-passenger="${b.passenger}"
                                        data-social-id="${b.social_id || ''}"
                                        data-phone="${b.phone_number || ''}"
                                        data-dob="${b.date_of_birth || ''}"
                                        data-status="${b.status}">
                                    Edit
                                </button>
                                <button class="btn-small btn-warning delete-booking" data-id="${b.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                table.innerHTML = html;
                
                // Attach Details button listeners
                document.querySelectorAll('.view-booking-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const modal = document.getElementById('booking-details-modal');
                        const body = document.getElementById('booking-details-body');
                        body.innerHTML = `
                            <p><strong>ID:</strong> ${btn.dataset.id}</p>
                            <p><strong>Passenger:</strong> ${btn.dataset.passenger}</p>
                            <p><strong>Origin:</strong> ${btn.dataset.origin}</p>
                            <p><strong>Destination:</strong> ${btn.dataset.destination}</p>
                            <p><strong>Social ID:</strong> ${btn.dataset.socialId || 'N/A'}</p>
                            <p><strong>Phone:</strong> ${btn.dataset.phone || 'N/A'}</p>
                            <p><strong>DOB:</strong> ${btn.dataset.dob || 'N/A'}</p>
                            <p><strong>Booking Date:</strong> ${btn.dataset.bookingDate}</p>
                            <p><strong>Status:</strong> ${btn.dataset.status}</p>
                        `;
                        modal.style.display = 'block';
                    });
                });
                
                // Close details modal
                document.getElementById('booking-details-close').addEventListener('click', () => {
                    document.getElementById('booking-details-modal').style.display = 'none';
                });
                window.addEventListener('click', function(event) {
                    const modal = document.getElementById('booking-details-modal');
                    if (event.target === modal) modal.style.display = 'none';
                });
                
                document.querySelectorAll('.edit-booking').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const id = this.getAttribute('data-id');
                        const tripId = this.getAttribute('data-trip-id');
                        const passenger = this.getAttribute('data-passenger');
                        const socialId = this.getAttribute('data-social-id');
                        const phone = this.getAttribute('data-phone');
                        const dob = this.getAttribute('data-dob');
                        const status = this.getAttribute('data-status');
                        // Populate form fields
                        document.getElementById('edit-booking-id').value = id;
                        document.getElementById('edit-booking-passenger').value = passenger;
                        document.getElementById('edit-booking-social-id').value = socialId;
                        document.getElementById('edit-booking-phone').value = phone;
                        document.getElementById('edit-booking-dob').value = dob;
                        document.getElementById('edit-booking-status').value = status;
                        // Load trip options and set to current trip
                        await window.loadTripOptions(editBookingTrip);
                        editBookingTrip.value = tripId;
                        // Update capacity info for this trip
                        updateEditTripCapacityInfo(tripId, false);
                        // Show the Edit Booking modal
                        editBookingModal.style.display = 'block';
                    });
                });
                
                document.querySelectorAll('.delete-booking').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const id = this.getAttribute('data-id');
                        showConfirmDialog('Delete Booking', 'Are you sure you want to delete this booking? This action cannot be undone.', async () => {
                            const res = await fetch(`/manager/bookings/${id}`, { method: 'DELETE' });
                            if (res.ok) loadBookings();
                        });
                    });
                });
                
                // Populate the filter dropdowns with unique values
                const origins = [...new Set(bookings.map(b => b.origin))];
                const destinations = [...new Set(bookings.map(b => b.destination))];
                
                const originSelect = document.getElementById('filter-origin');
                const destinationSelect = document.getElementById('filter-destination');
                
                // Clear existing options except the first one
                while (originSelect.options.length > 1) originSelect.remove(1);
                while (destinationSelect.options.length > 1) destinationSelect.remove(1);
                
                // Add new options
                origins.forEach(origin => {
                    const option = document.createElement('option');
                    option.value = origin;
                    option.textContent = origin;
                    originSelect.appendChild(option);
                });
                
                destinations.forEach(destination => {
                    const option = document.createElement('option');
                    option.value = destination;
                    option.textContent = destination;
                    destinationSelect.appendChild(option);
                });
               // Update pagination display
               document.getElementById('current-page').textContent = currentPage;
               document.getElementById('total-pages').textContent = totalPages;
               document.getElementById('prev-page').disabled = currentPage <= 1;
               document.getElementById('next-page').disabled = currentPage >= totalPages;
            }
            // Setup filter handlers
            document.getElementById('filter-apply').addEventListener('click', () => {
                const filters = {
                    passenger: document.getElementById('filter-passenger').value,
                    origin: document.getElementById('filter-origin').value,
                    destination: document.getElementById('filter-destination').value,
                    status: document.getElementById('filter-status').value
                };
                
                const sortBy = document.getElementById('sort-by').value;
                const sortDir = document.getElementById('sort-direction').value;
                
                loadBookings(filters, sortBy, sortDir);
            });
            
            document.getElementById('filter-reset').addEventListener('click', () => {
                document.getElementById('filter-passenger').value = '';
                document.getElementById('filter-origin').value = '';
                document.getElementById('filter-destination').value = '';
                document.getElementById('filter-status').value = '';
                document.getElementById('sort-by').value = 'date';
                document.getElementById('sort-direction').value = 'desc';
                
                loadBookings();
            });
            
            document.getElementById('sort-apply').addEventListener('click', () => {
                const filters = {
                    passenger: document.getElementById('filter-passenger').value,
                    origin: document.getElementById('filter-origin').value,
                    destination: document.getElementById('filter-destination').value,
                    status: document.getElementById('filter-status').value
                };
                
                const sortBy = document.getElementById('sort-by').value;
                const sortDir = document.getElementById('sort-direction').value;
                
                loadBookings(filters, sortBy, sortDir);
            });

            // Add Booking modal
            addBookingBtn.addEventListener('click', function() {
                // Show the Add Booking modal
                addBookingModal.style.display = 'block';
                // Update capacity info for the currently selected trip, but don't show notification
                updateTripCapacityInfo(bookingTripSelect.value, false);
            });
            document.querySelectorAll('#add-booking-modal .cancel-btn, #add-booking-modal .close').forEach(b => b.addEventListener('click', () => addBookingModal.style.display = 'none'));
            window.addEventListener('click', e => { if (e.target === addBookingModal) addBookingModal.style.display = 'none'; });
            addBookingForm.addEventListener('submit', async e => {
                e.preventDefault();
                // Validate Booking form inputs
                const passengerVal = document.getElementById('booking-passenger').value;
                const socialVal = document.getElementById('booking-social-id').value;
                const phoneVal = document.getElementById('booking-phone').value;
                const dobVal = document.getElementById('booking-dob').value;
                const nameRegex = /^[A-Za-z\s]{2,50}$/;
                const socialRegex = /^\d{10}$/;
                const phoneRegex = /^\+?[0-9]{7,15}$/;
                const today = new Date().toISOString().split('T')[0];
                if (!nameRegex.test(passengerVal)) { showToast('error', 'Validation Error', 'Passenger name must be 2‚Äì50 letters'); return; }
                if (!socialRegex.test(socialVal)) { showToast('error', 'Validation Error', 'Social ID must be exactly 10 digits'); return; }
                if (!phoneRegex.test(phoneVal)) { showToast('error', 'Validation Error', 'Phone number must be 7‚Äì15 digits; may start with +'); return; }
                if (dobVal && dobVal >= today) { showToast('error', 'Validation Error', 'Date of Birth must be in the past'); return; }
                const res = await fetch('/manager/bookings/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        trip_id: parseInt(bookingTripSelect.value),
                        passenger: document.getElementById('booking-passenger').value,
                        social_id: document.getElementById('booking-social-id').value,
                        phone_number: document.getElementById('booking-phone').value,
                        date_of_birth: document.getElementById('booking-dob').value,
                        status: document.getElementById('booking-status').value
                    })
                });
                if (res.ok) { addBookingModal.style.display = 'none'; loadBookings(); }
            });

            // Edit Booking modal
            document.querySelectorAll('#edit-booking-modal .cancel-btn, #edit-booking-modal .close').forEach(b => b.addEventListener('click', () => editBookingModal.style.display = 'none'));
            window.addEventListener('click', e => { if (e.target === editBookingModal) editBookingModal.style.display = 'none'; });
            editBookingForm.addEventListener('submit', async e => {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-booking-id').value);
                const res = await fetch('/manager/bookings/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id,
                        status: document.getElementById('edit-booking-status').value
                    })
                });
                if (res.ok) { 
                    editBookingModal.style.display = 'none'; 
                    loadBookings();
                    // Refresh capacity info after cancellation to free seats
                    if (typeof updateTripCapacityInfo === 'function') updateTripCapacityInfo(bookingTripSelect.value, false);
                    if (typeof updateEditTripCapacityInfo === 'function') updateEditTripCapacityInfo(editBookingTrip.value, false);
                }
            });

            // Search bookings
            document.getElementById('booking-search').addEventListener('input', function () {
                const term = this.value.toLowerCase();
                document.querySelectorAll('#bookings-table tbody tr').forEach(r => {
                    r.style.display = r.textContent.toLowerCase().includes(term) ? '' : 'none';
                });
            });

            // Load bookings when Manage Bookings clicked
            document.querySelector('a[href="#bookings"]').addEventListener('click', loadBookings);
        }

        // Vehicle filters
        document.getElementById('vehicle-filter-apply').addEventListener('click', function() {
            const num = document.getElementById('filter-vehicle-number').value.toLowerCase();
            const type = document.getElementById('filter-vehicle-type').value;
            const status = document.getElementById('filter-vehicle-status').value;
            const minCapacity = document.getElementById('filter-vehicle-capacity-min').value;
            const maxCapacity = document.getElementById('filter-vehicle-capacity-max').value;
            
            document.querySelectorAll('#vehicles-table tbody tr').forEach(row => {
                const cells = row.cells;
                const vnum = cells[1].textContent.toLowerCase();
                const vtype = cells[2].textContent;
                const vcapacity = parseInt(cells[3].textContent, 10);
                const vstatus = cells[4].textContent;
                
                const matchesCapacity = (
                    (minCapacity === '' || vcapacity >= parseInt(minCapacity, 10)) &&
                    (maxCapacity === '' || vcapacity <= parseInt(maxCapacity, 10))
                );
                
                const visible = 
                    (!num || vnum.includes(num)) && 
                    (!type || vtype === type) && 
                    (!status || vstatus === status) &&
                    matchesCapacity;
                    
                row.style.display = visible ? '' : 'none';
            });
        });
        document.getElementById('vehicle-filter-reset').addEventListener('click', function() {
            document.getElementById('filter-vehicle-number').value = '';
            document.getElementById('filter-vehicle-type').value = '';
            document.getElementById('filter-vehicle-status').value = '';
            document.getElementById('filter-vehicle-capacity-min').value = '';
            document.getElementById('filter-vehicle-capacity-max').value = '';
            loadVehicles();
        });
        // Populate vehicle types filter when loading vehicles
        const originalLoadVehicles = loadVehicles;
        loadVehicles = function() {
            originalLoadVehicles();
            fetch('/manager/vehicles')
                .then(res => res.json())
                .then(vehicles => {
                    const typeSelect = document.getElementById('filter-vehicle-type');
                    const types = [...new Set(vehicles.map(v => v.type))];
                    while (typeSelect.options.length > 1) typeSelect.remove(1);
                    types.forEach(t => {
                        const opt = document.createElement('option'); opt.value = t; opt.textContent = t; typeSelect.appendChild(opt);
                    });
                });
        };
        // Reports functionality
        const reportGenerateBtn = document.getElementById('report-generate-btn');
        const reportExportBtn = document.getElementById('report-export-btn');
        const reportTypeSelect = document.getElementById('report-type-select');
        const reportFromInput = document.getElementById('report-from-date');
        const reportToInput = document.getElementById('report-to-date');
        const reportOutput = document.getElementById('report-output');
        if (reportGenerateBtn && reportExportBtn && reportTypeSelect && reportFromInput && reportToInput && reportOutput) {
            reportGenerateBtn.addEventListener('click', async () => {
                const type = reportTypeSelect.value;
                const from = reportFromInput.value;
                const to = reportToInput.value;
                if (!type || !from || !to) {
                    showToast('error', 'Missing parameters', 'Please select report type and date range');
                    return;
                }
                try {
                    const res = await fetch(`/manager/reports/data?report=${type}&from=${from}&to=${to}`);
                    if (!res.ok) throw new Error(res.statusText);
                    const payload = await res.json();
                    renderReportTable(payload.columns, payload.rows);
                } catch (err) {
                    showToast('error', 'Report Error', 'Failed to load report: ' + err);
                }
            });
            reportExportBtn.addEventListener('click', () => {
                const type = reportTypeSelect.value;
                const from = reportFromInput.value;
                const to = reportToInput.value;
                if (!type || !from || !to) {
                    showToast('error', 'Missing parameters', 'Please select report type and date range');
                    return;
                }
                window.location = `/manager/reports/export?report=${type}&from=${from}&to=${to}`;
            });
        }
        function renderReportTable(columns, rows) {
            let html = `<div class="table-responsive"><table><thead><tr>`;
            columns.forEach(col => { html += `<th>${col.replace(/_/g, ' ').toUpperCase()}</th>`; });
            html += `</tr></thead><tbody>`;
            rows.forEach(row => {
                html += `<tr>`;
                columns.forEach(col => { html += `<td>${row[col] ?? ''}</td>`; });
                html += `</tr>`;
            });
            html += `</tbody></table></div>`;
            reportOutput.innerHTML = html;
        }
        // Backup functionality
        const backupNowBtn = document.getElementById('backup-now-btn');
        const backupDownloadLink = document.getElementById('backup-download-link');
        const backupStatus = document.getElementById('backup-status');
        if (backupNowBtn && backupDownloadLink && backupStatus) {
            backupNowBtn.addEventListener('click', async () => {
                backupStatus.textContent = 'Backing up...';
                try {
                    const res = await fetch('/manager/backup', { method: 'POST' });
                    if (!res.ok) throw new Error((await res.json()).error || res.statusText);
                    showToast('success', 'Backup Successful', 'Database backup created.');
                    const now = new Date().toLocaleString();
                    backupStatus.textContent = `Last backup: ${now}`;
                    backupDownloadLink.href = '/manager/backup/download';
                    backupDownloadLink.hidden = false;
                } catch (err) {
                    showToast('error', 'Backup Failed', err.message);
                    backupStatus.textContent = '';
                }
            });
        }

        // On initial load, simulate click on the correct tab from URL hash to trigger its data loader
        if (window.location.hash) {
            const sectionName = window.location.hash.substring(1);
            const hashLink = document.querySelector(`.sidebar-menu a[href="#${sectionName}"]`) ||
                             document.querySelector(`.overview-feature[href="#${sectionName}"]`);
            if (hashLink) {
                hashLink.click();
            }
        }
    });

    // Function to show a custom confirmation dialog instead of the browser's confirm()
    function showConfirmDialog(title, message, confirmCallback, type = 'warning') {
        const container = document.getElementById('confirm-dialog-container');
        const titleElem = document.getElementById('confirm-dialog-title');
        const messageElem = document.getElementById('confirm-dialog-message');
        const confirmBtn = document.getElementById('confirm-dialog-confirm');
        const cancelBtn = document.getElementById('confirm-dialog-cancel');
        
        // Set content
        titleElem.textContent = title;
        messageElem.textContent = message;
        
        // Set button style based on type
        confirmBtn.className = 'confirm-dialog-confirm';
        if (type === 'primary') confirmBtn.classList.add('confirm-primary');
        else if (type === 'warning') confirmBtn.classList.add('confirm-warning');
        
        // Clear previous event listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        // Add event listeners
        newConfirmBtn.addEventListener('click', () => {
            container.classList.remove('active');
            if (typeof confirmCallback === 'function') {
                setTimeout(confirmCallback, 100);
            }
        });
        
        newCancelBtn.addEventListener('click', () => {
            container.classList.remove('active');
        });
        
        // Show the dialog
        container.classList.add('active');
        
        // Close on background click
        container.addEventListener('click', (e) => {
            if (e.target === container) {
                container.classList.remove('active');
            }
        });
    }

    function navigateToSection(sectionName) {
        // Remove active class from all sidebar links and content sections
        document.querySelectorAll('.sidebar-menu li').forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

        // Add active class to the target sidebar link and content section
        const targetSidebarLink = document.querySelector(`.sidebar-menu a[href="#${sectionName}"]`);
        if (targetSidebarLink) {
            targetSidebarLink.parentElement.classList.add('active');
        }

        const targetContentSection = document.getElementById(`${sectionName}-section`);
        if (targetContentSection) {
            targetContentSection.classList.add('active');
        }
    }

    // Attach listeners to all navigation links (sidebar and overview cards)
    document.querySelectorAll('.sidebar-menu a, .overview-feature').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const sectionName = this.getAttribute('href').substring(1);
            navigateToSection(sectionName);
            history.pushState(null, '', '#' + sectionName);
        });
    });

    // Custom validation functions
    function validateUsername(usernameInput, errorDiv) {
        const username = usernameInput.value;
        const baseRegex = /^[0-9A-Za-z_-]{3,30}$/;
        let isValid = true;
        let errorMessage = '';

        if (!baseRegex.test(username)) {
            isValid = false;
            errorMessage = 'Username must be 3-30 characters long and contain only letters, numbers, underscores (_), or hyphens (-).';
        } else if (/^[0-9]/.test(username)) {
            isValid = false;
            errorMessage = 'Username cannot start with a number.';
        } else if (username.startsWith('_') || username.startsWith('-')) {
            isValid = false;
            errorMessage = 'Username cannot start with an underscore (_) or hyphen (-).';
        } else if (username.endsWith('_') || username.endsWith('-')) {
            isValid = false;
            errorMessage = 'Username cannot end with an underscore (_) or hyphen (-).';
        } else if (username.includes('__') || username.includes('--') || username.includes('-_') || username.includes('_-')) {
            isValid = false;
            errorMessage = 'Username cannot contain consecutive underscores (_) or hyphens (-).';
        }

        if (!isValid) {
            usernameInput.style.borderColor = 'red';
            errorDiv.textContent = errorMessage;
            errorDiv.style.display = 'block';
        } else {
            usernameInput.style.borderColor = '';
            errorDiv.style.display = 'none';
        }
        return isValid;
    }

    function validatePassword(passwordInput) {
        const criteriaList = passwordInput.parentElement.nextElementSibling; // Adjusted selector
        const pwd = passwordInput.value;
        const lengthCrit = criteriaList.querySelector('.passwordLength');
        const upperCrit = criteriaList.querySelector('.passwordUpper');
        const lowerCrit = criteriaList.querySelector('.passwordLower');
        const numberCrit = criteriaList.querySelector('.passwordNumber');
        const symbolCrit = criteriaList.querySelector('.passwordSymbol');
        let isValid = true;
        if (pwd.length >= 8) { lengthCrit.style.color = 'green'; } else { lengthCrit.style.color = 'red'; isValid = false; }
        if (/[A-Z]/.test(pwd)) { upperCrit.style.color = 'green'; } else { upperCrit.style.color = 'red'; isValid = false; }
        if (/[a-z]/.test(pwd)) { lowerCrit.style.color = 'green'; } else { lowerCrit.style.color = 'red'; isValid = false; }
        if (/[0-9]/.test(pwd)) { numberCrit.style.color = 'green'; } else { numberCrit.style.color = 'red'; isValid = false; }
        if (/[^A-Za-z0-9]/.test(pwd)) { symbolCrit.style.color = 'green'; } else { symbolCrit.style.color = 'red'; isValid = false; }
        return isValid;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Add validation listeners for "Add Member"
        const addMemberUsernameInput = document.getElementById('member-name');
        const addMemberPasswordInput = document.getElementById('member-password');
        if(addMemberUsernameInput) {
            addMemberUsernameInput.addEventListener('input', () => validateUsername(addMemberUsernameInput, document.getElementById('addUsernameError')));
        }
        if(addMemberPasswordInput) {
            addMemberPasswordInput.addEventListener('input', () => validatePassword(addMemberPasswordInput));
            addMemberPasswordInput.addEventListener('focus', () => addMemberPasswordInput.parentElement.nextElementSibling.style.display = 'block');
            addMemberPasswordInput.addEventListener('blur', () => addMemberPasswordInput.parentElement.nextElementSibling.style.display = 'none');
        }

        // Add validation listeners for "Change Username"
        const changeUsernameInput = document.getElementById('new-username');
        if(changeUsernameInput) {
            changeUsernameInput.addEventListener('input', () => validateUsername(changeUsernameInput, document.getElementById('changeUsernameError')));
        }

        // Add validation listeners for "Change Password"
        const changePasswordInput = document.getElementById('new-password');
        if(changePasswordInput) {
            changePasswordInput.addEventListener('input', () => validatePassword(changePasswordInput));
            changePasswordInput.addEventListener('focus', () => changePasswordInput.parentElement.nextElementSibling.style.display = 'block');
            changePasswordInput.addEventListener('blur', () => changePasswordInput.parentElement.nextElementSibling.style.display = 'none');
        }

        // Setup password toggles
        document.querySelectorAll('.password-toggle').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const passwordInput = this.previousElementSibling;
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                } else {
                    passwordInput.type = 'password';
                }
            });
        });
    });
</script>
{{end}} 